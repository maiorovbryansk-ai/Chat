<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PING</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b1020;
  --panel:#0f1724;
  --accent:#4f9cff;
  --muted:#9aa4b2;
  color-scheme:dark;
  font-family:Inter,system-ui;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background:linear-gradient(180deg,#0b1020,#050b18);
  color:#e6eef8;
}
#app{height:100%;display:flex}

/* layout */
.sidebar{
  width:300px;
  background:var(--panel);
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.main{
  flex:1;
  display:flex;
  flex-direction:column;
}
.header{
  padding:12px 16px;
  border-bottom:1px solid rgba(255,255,255,.05);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.list{flex:1;overflow:auto}
.chat{
  padding:10px;
  border-radius:8px;
  cursor:pointer;
}
.chat.active{background:rgba(79,156,255,.15)}
.chat:hover{background:rgba(255,255,255,.03)}
.messages{
  flex:1;
  padding:16px;
  overflow:auto;
  background:linear-gradient(180deg,#071025,#0b1530);
}
.msg{
  max-width:70%;
  padding:10px;
  border-radius:10px;
  margin-bottom:8px;
  word-break:break-word;
}
.me{margin-left:auto;background:var(--accent);color:#fff}
.their{background:rgba(255,255,255,.05)}
.composer{
  display:flex;
  padding:12px;
  gap:8px;
}
textarea{
  flex:1;
  resize:none;
  border:0;
  border-radius:8px;
  padding:10px;
  background:#061226;
  color:inherit;
}
button{
  border:0;
  border-radius:8px;
  padding:10px 14px;
  background:var(--accent);
  color:white;
  cursor:pointer;
}
button:disabled{opacity:.5;cursor:not-allowed}
.muted{color:var(--muted);font-size:13px}
.center{
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
}
.card{
  background:var(--panel);
  padding:24px;
  border-radius:12px;
  width:100%;
  max-width:420px;
}
.error{color:#ff7a7a;font-size:13px}
</style>
</head>

<body>
<div id="app"></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

/* ===== CONFIG ===== */
const SUPABASE_URL = 'https://mhgbfyztvtqikpqufphm.supabase.co'
const SUPABASE_ANON_KEY = 'sb_publishable_FC_9UNlytgDXFKkapVTNOQ_uGdRMXjT'
/* ================= */

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
const app = document.getElementById('app')

const state = {
  user:null,
  chats:[],
  activeChat:null,
  messages:{},
  sub:null
}

/* ===== INIT ===== */
init()

async function init(){
  renderLoading()

  try{
    const { data, error } = await supabase.auth.getSession()
    if(error) throw error

    if(data.session){
      state.user = data.session.user
      await loadChats()
      renderApp()
    } else {
      renderLogin()
    }

    supabase.auth.onAuthStateChange((_e,s)=>{
      if(!s){
        state.user=null
        renderLogin()
      }
    })
  }catch(e){
    renderFatal('Ошибка инициализации')
    console.error(e)
  }
}

/* ===== AUTH UI ===== */
function renderLogin(msg=''){
  app.innerHTML=`
    <div class="center">
      <div class="card">
        <h2>PING</h2>
        <p class="muted">Вход по email, пришлём magic link</p>
        <input id="email" type="email" placeholder="email@example.com" style="width:100%;padding:10px;border-radius:8px;border:0;background:#061226;color:inherit"/>
        <button id="login" style="width:100%;margin-top:12px">Войти</button>
        ${msg?`<div class="error">${msg}</div>`:''}
      </div>
    </div>`
  document.getElementById('login').onclick=sendLink
}

async function sendLink(){
  const email=document.getElementById('email').value.trim()
  if(!email) return renderLogin('Введите email')

  const { error } = await supabase.auth.signInWithOtp({
    email,
    options:{ emailRedirectTo: window.location.origin }
  })
  if(error) renderLogin('Ошибка отправки')
  else renderLogin('Проверь почту')
}

/* ===== APP ===== */
function renderApp(){
  app.innerHTML=`
    <div class="sidebar">
      <div><strong>PING</strong></div>
      <div id="chats" class="list"></div>
      <button id="logout">Выйти</button>
    </div>
    <div class="main">
      <div class="header">
        <div id="title">Выбери чат</div>
      </div>
      <div id="messages" class="messages"></div>
      <div class="composer">
        <textarea id="input" rows="1"></textarea>
        <button id="send" disabled>Send</button>
      </div>
    </div>`

  document.getElementById('logout').onclick=()=>supabase.auth.signOut()
  document.getElementById('input').oninput=e=>{
    document.getElementById('send').disabled=!e.target.value.trim()
  }
  document.getElementById('send').onclick=sendMessage

  renderChats()
}

/* ===== CHATS ===== */
async function loadChats(){
  const { data } = await supabase.rpc('rpc_get_user_chats')
  state.chats=data||[]
}

function renderChats(){
  const box=document.getElementById('chats')
  box.innerHTML=''
  state.chats.forEach(c=>{
    const d=document.createElement('div')
    d.className='chat'+(state.activeChat===c.chat_id?' active':'')
    d.textContent=c.partner_username||'User'
    d.onclick=()=>openChat(c.chat_id,c.partner_username)
    box.appendChild(d)
  })
}

/* ===== MESSAGES ===== */
async function openChat(id,title){
  state.activeChat=id
  document.getElementById('title').textContent=title||'Chat'
  renderChats()

  if(state.sub) state.sub.unsubscribe()

  const { data } = await supabase
    .from('messages')
    .select('*')
    .eq('chat_id',id)
    .order('created_at',{ascending:true})
    .limit(50)

  state.messages[id]=data||[]
  renderMessages()

  state.sub = supabase.channel('chat-'+id)
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`chat_id=eq.${id}`},p=>{
      state.messages[id].push(p.new)
      renderMessages()
    })
    .subscribe()
}

function renderMessages(){
  const box=document.getElementById('messages')
  box.innerHTML=''
  const arr=state.messages[state.activeChat]||[]
  arr.forEach(m=>{
    const d=document.createElement('div')
    d.className='msg '+(m.sender_id===state.user.id?'me':'their')
    d.textContent=m.content
    box.appendChild(d)
  })
  box.scrollTop=box.scrollHeight
}

async function sendMessage(){
  const input=document.getElementById('input')
  const text=input.value.trim()
  if(!text) return
  input.value=''
  document.getElementById('send').disabled=true

  await supabase.from('messages').insert({
    chat_id:state.activeChat,
    sender_id:state.user.id,
    content:text
  })
}

/* ===== ERRORS ===== */
function renderLoading(){
  app.innerHTML='<div class="center"><div class="muted">Загрузка…</div></div>'
}
function renderFatal(msg){
  app.innerHTML='<div class="center"><div class="error">'+msg+'</div></div>'
}
</script>
</body>
</html>
