<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Supabase Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Сброс и базовые стили */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-color: #0084ff;
            --primary-dark: #0066cc;
            --bg-color: #ffffff;
            --bg-secondary: #f0f2f5;
            --bg-tertiary: #e4e6eb;
            --text-primary: #050505;
            --text-secondary: #65676b;
            --border-color: #ddd;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
            --radius-sm: 8px;
            --header-height: 56px;
            --footer-height: 60px;
            --transition: all 0.2s ease;
            --success-color: #31a24c;
            --error-color: #f02849;
            --warning-color: #f7b928;
            --reaction-bg: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Общие компоненты */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            white-space: nowrap;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: #d8dadf;
        }

        .btn-text {
            background: none;
            color: var(--primary-color);
            padding: 8px;
        }

        .btn-text:hover {
            background-color: rgba(0, 132, 255, 0.1);
        }

        .input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 15px;
            transition: var(--transition);
            background-color: white;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 132, 255, 0.2);
        }

        .card {
            background-color: var(--bg-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            width: 100%;
            max-width: 400px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background-color: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 16px;
        }

        .avatar-lg {
            width: 80px;
            height: 80px;
            font-size: 24px;
        }

        .hidden {
            display: none !important;
        }

        /* Авторизация */
        #auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background-color: var(--bg-secondary);
        }

        .auth-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 400px;
        }

        .auth-tabs {
            display: flex;
            background-color: white;
            border-radius: var(--radius-sm);
            padding: 4px;
            margin-bottom: 10px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 600;
            transition: var(--transition);
        }

        .auth-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .form-error {
            color: var(--error-color);
            font-size: 14px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Основной экран */
        #app {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            height: var(--header-height);
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-weight: 700;
            font-size: 20px;
            color: var(--primary-color);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* Основной контент */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Список чатов */
        #chats-list {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
        }

        .chats-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        #user-search-input {
            padding-left: 40px;
        }

        .chats-container {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
        }

        .chat-item:hover {
            background-color: var(--bg-secondary);
        }

        .chat-item.active {
            background-color: rgba(0, 132, 255, 0.1);
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-last-message {
            color: var(--text-secondary);
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-time {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        /* Экран чата */
        #chat-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-secondary);
            height: 100%;
        }

        .chat-header {
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .chat-header-status {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            display: flex;
            max-width: 80%;
            animation: messageAppear 0.2s ease;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-outgoing {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            word-break: break-word;
            position: relative;
        }

        .message-outgoing .message-bubble {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-incoming .message-bubble {
            background-color: white;
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message-time {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.7;
            text-align: right;
        }

        .message-reactions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .reaction {
            background-color: var(--reaction-bg);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .reaction:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .reaction.active {
            background-color: rgba(0, 132, 255, 0.15);
        }

        .message-footer {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .message-input-container {
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #message-input {
            flex: 1;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            border: none;
            outline: none;
            font-size: 15px;
            font-family: inherit;
            padding: 8px 0;
            line-height: 1.4;
        }

        /* Профиль */
        #profile-screen {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            overflow-y: auto;
        }

        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .avatar-upload {
            position: relative;
            cursor: pointer;
        }

        .avatar-upload:hover .avatar-overlay {
            opacity: 1;
        }

        .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            opacity: 0;
            transition: var(--transition);
        }

        .profile-info {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Уведомления */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: white;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 350px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .notification-success .notification-icon {
            background-color: var(--success-color);
        }

        .notification-error .notification-icon {
            background-color: var(--error-color);
        }

        .notification-warning .notification-icon {
            background-color: var(--warning-color);
        }

        .notification-info .notification-icon {
            background-color: var(--primary-color);
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        /* Загрузка */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 132, 255, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Адаптивные стили */
        @media (max-width: 768px) {
            .main-content {
                position: relative;
            }
            
            #chats-list, #chat-screen, #profile-screen {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                transition: transform 0.3s ease;
            }
            
            #chat-screen.hidden {
                transform: translateX(100%);
            }
            
            #profile-screen.hidden {
                transform: translateX(100%);
            }
            
            .chat-item {
                padding: 10px 12px;
            }
        }

        @media (min-width: 769px) {
            #chats-list {
                width: 360px;
                border-right: 1px solid var(--border-color);
            }
            
            #chat-screen {
                width: calc(100% - 360px);
            }
        }

        /* Прокрутка */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Настройки */
        .config-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 12px rgba(0,0,0,0.1);
            padding: 20px;
            transition: right 0.3s ease;
            z-index: 1001;
            overflow-y: auto;
        }

        .config-panel.open {
            right: 0;
        }

        .config-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .config-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
    </style>
</head>
<body>
    <!-- Экран авторизации -->
    <div id="auth-screen">
        <div class="auth-container card">
            <div class="auth-tabs">
                <div class="auth-tab active" id="login-tab">Вход</div>
                <div class="auth-tab" id="register-tab">Регистрация</div>
            </div>
            
            <div id="login-form" class="auth-form">
                <div class="form-group">
                    <label class="form-label" for="login-email">Email</label>
                    <input type="email" id="login-email" class="input" placeholder="Ваш email">
                </div>
                <div class="form-group">
                    <label class="form-label" for="login-password">Пароль</label>
                    <input type="password" id="login-password" class="input" placeholder="Ваш пароль">
                </div>
                <div id="login-error" class="form-error hidden">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Ошибка входа</span>
                </div>
                <button id="login-btn" class="btn btn-primary">Войти</button>
                <button id="config-toggle" class="btn btn-text" style="margin-top: 10px;">
                    <i class="fas fa-cog"></i> Настройки
                </button>
            </div>
            
            <div id="register-form" class="auth-form hidden">
                <div class="form-group">
                    <label class="form-label" for="register-email">Email</label>
                    <input type="email" id="register-email" class="input" placeholder="Ваш email">
                </div>
                <div class="form-group">
                    <label class="form-label" for="register-password">Пароль</label>
                    <input type="password" id="register-password" class="input" placeholder="Минимум 6 символов">
                </div>
                <div id="register-error" class="form-error hidden">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Ошибка регистрации</span>
                </div>
                <button id="register-btn" class="btn btn-primary">Зарегистрироваться</button>
                <button id="config-toggle-register" class="btn btn-text" style="margin-top: 10px;">
                    <i class="fas fa-cog"></i> Настройки
                </button>
            </div>
        </div>
    </div>
    
    <!-- Панель настроек -->
    <div id="config-overlay" class="config-overlay"></div>
    <div id="config-panel" class="config-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Настройки Supabase</h2>
            <button id="close-config" class="btn btn-text">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div style="margin-bottom: 20px; padding: 15px; background-color: var(--bg-secondary); border-radius: var(--radius-sm); font-size: 14px;">
            <p style="margin-bottom: 10px; font-weight: 600;">Инструкция:</p>
            <ol style="padding-left: 20px; margin-bottom: 10px;">
                <li>Создайте проект в <a href="https://supabase.com" target="_blank">Supabase</a></li>
                <li>Выполните SQL скрипт из schema.sql</li>
                <li>Вставьте URL и anon ключ ниже</li>
            </ol>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="supabase-url">Supabase Project URL</label>
            <input type="text" id="supabase-url" class="input" placeholder="https://your-project.supabase.co">
        </div>
        <div class="form-group">
            <label class="form-label" for="supabase-key">Supabase anon key</label>
            <input type="text" id="supabase-key" class="input" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">
                После сохранения настроек приложение перезагрузится.
            </p>
            <button id="save-config-btn" class="btn btn-primary" style="width: 100%;">Сохранить и перезагрузить</button>
            <button id="reset-config-btn" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">Сбросить настройки</button>
        </div>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 15px;">Тестовый проект</h3>
            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 15px;">
                Для быстрого тестирования можно использовать демо-данные (только для ознакомления):
            </p>
            <button id="use-demo-config" class="btn btn-secondary" style="width: 100%;">
                Использовать тестовые данные
            </button>
            <p style="font-size: 12px; color: var(--warning-color); margin-top: 10px;">
                Внимание: тестовый проект может быть недоступен
            </p>
        </div>
    </div>
    
    <!-- Основное приложение -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button id="menu-btn" class="btn btn-text">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="header-title">Supabase Messenger</h1>
            </div>
            <div class="header-actions">
                <button id="config-btn" class="btn btn-text" title="Настройки">
                    <i class="fas fa-cog"></i>
                </button>
                <button id="profile-btn" class="btn btn-text" title="Профиль">
                    <i class="fas fa-user"></i>
                </button>
                <button id="logout-btn" class="btn btn-text" title="Выйти">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>
        
        <!-- Основной контент -->
        <div class="main-content">
            <!-- Список чатов -->
            <div id="chats-list">
                <div class="chats-header">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="user-search-input" class="input" placeholder="Найти пользователя по @nickname">
                    </div>
                </div>
                <div id="search-results" class="chats-container hidden"></div>
                <div id="chats-container" class="chats-container">
                    <div class="loading" id="chats-loading">
                        <div class="spinner"></div>
                    </div>
                    <!-- Список чатов будет загружен динамически -->
                </div>
            </div>
            
            <!-- Экран чата -->
            <div id="chat-screen" class="hidden">
                <div class="chat-header">
                    <button id="back-btn" class="btn btn-text">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div id="chat-avatar" class="avatar"></div>
                    <div class="chat-header-info">
                        <div id="chat-name" class="chat-header-name"></div>
                        <div id="chat-status" class="chat-header-status">В сети</div>
                    </div>
                </div>
                
                <div id="messages-container" class="messages-container">
                    <div class="loading" id="messages-loading">
                        <div class="spinner"></div>
                    </div>
                    <!-- Сообщения будут загружены динамически -->
                </div>
                
                <div class="message-input-container">
                    <button id="emoji-btn" class="btn btn-text">
                        <i class="far fa-smile"></i>
                    </button>
                    <textarea id="message-input" class="input" placeholder="Введите сообщение..." rows="1"></textarea>
                    <button id="send-btn" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            
            <!-- Экран профиля -->
            <div id="profile-screen" class="hidden">
                <button id="profile-back-btn" class="btn btn-text" style="align-self: flex-start;">
                    <i class="fas fa-arrow-left"></i> Назад
                </button>
                
                <div class="profile-header">
                    <div class="avatar-upload">
                        <div id="profile-avatar" class="avatar avatar-lg"></div>
                        <div class="avatar-overlay">
                            <i class="fas fa-camera"></i>
                        </div>
                        <input type="file" id="avatar-input" accept="image/jpeg,image/png,image/webp" class="hidden">
                    </div>
                    <h2 id="profile-name"></h2>
                    <div id="profile-nickname" style="color: var(--text-secondary);"></div>
                </div>
                
                <div class="profile-info card">
                    <div class="form-group">
                        <label class="form-label" for="nickname-input">Никнейм (@nickname)</label>
                        <input type="text" id="nickname-input" class="input" placeholder="@username">
                        <small style="color: var(--text-secondary); margin-top: 5px;">Может содержать буквы, цифры и _</small>
                    </div>
                    <div id="nickname-error" class="form-error hidden">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Ошибка обновления никнейма</span>
                    </div>
                    <button id="update-nickname-btn" class="btn btn-primary">Обновить никнейм</button>
                </div>
                
                <div class="card" style="width: 100%;">
                    <h3 style="margin-bottom: 15px;">Настройки уведомлений</h3>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <span>Push-уведомления</span>
                        <label class="switch">
                            <input type="checkbox" id="notifications-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button id="test-notification-btn" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-bell"></i> Тестовое уведомление
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Контейнер для уведомлений -->
    <div id="notifications-container"></div>
    
    <!-- Emoji picker (упрощенный) -->
    <div id="emoji-picker" class="hidden" style="position: fixed; bottom: 80px; right: 20px; background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 10px; z-index: 1000; width: 200px; max-height: 200px; overflow-y: auto;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            <!-- Emoji будут добавлены динамически -->
        </div>
    </div>

    <!-- Подключаем Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ============================================
        // КОНФИГУРАЦИЯ SUPABASE (ЗАМЕНИТЕ НА СВОИ)
        // ============================================
        
        // ПОЛУЧИТЕ В ПРОЕКТЕ SUPABASE: Settings → API
        const DEFAULT_SUPABASE_URL = 'https://geoojvchpycmsbdsmytu.supabase.co';  // Замените на свой URL
        const DEFAULT_SUPABASE_KEY = 'sb_publishable_9wNJrGlNHzidAHktXChLXw_nUqvt9NN';  // Замените на свой ключ
        
        // ============================================
        // КОНЕЦ КОНФИГУРАЦИИ
        // ============================================
        
        // Загрузка настроек из localStorage или использование значений по умолчанию
        let supabaseUrl = localStorage.getItem('supabaseUrl') || DEFAULT_SUPABASE_URL;
        let supabaseKey = localStorage.getItem('supabaseKey') || DEFAULT_SUPABASE_KEY;
        
        let supabaseClient = null; // Изменили имя переменной
        
        // Состояние приложения
        const appState = {
            currentUser: null,
            currentChat: null,
            currentScreen: 'chats',
            chats: [],
            users: {},
            notificationsEnabled: false,
            notificationPermission: null
        };
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', initApp);
        
        async function initApp() {
            // Настройка обработчиков событий
            setupEventListeners();
            
            // Проверяем разрешение на уведомления
            checkNotificationPermission();
            
            // Загружаем конфигурацию в форму
            loadConfigToForm();
            
            // Если есть конфигурация, инициализируем Supabase
            if (supabaseUrl && supabaseKey) {
                initSupabase();
            } else {
                // Если нет конфигурации, показываем настройки
                showNotification('Настройте Supabase для начала работы', 'warning');
                setTimeout(() => openConfigPanel(), 1000);
            }
        }
        
        function loadConfigToForm() {
            document.getElementById('supabase-url').value = supabaseUrl;
            document.getElementById('supabase-key').value = supabaseKey;
        }
        
        function initSupabase() {
            try {
                // Проверяем, что библиотека Supabase загружена
                if (typeof supabase === 'undefined') {
                    throw new Error('Библиотека Supabase не загружена. Проверьте подключение к интернету.');
                }
                
                // Инициализируем Supabase клиент
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: true
                    },
                    realtime: {
                        params: {
                            eventsPerSecond: 10
                        }
                    }
                });
                
                // Проверяем текущую сессию
                checkSession();
                
            } catch (error) {
                console.error('Ошибка инициализации Supabase:', error);
                showNotification('Ошибка инициализации Supabase. Проверьте настройки.', 'error');
                openConfigPanel();
            }
        }
        
        async function checkSession() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                if (error) throw error;
                
                if (session) {
                    await loadUserProfile(session.user.id);
                    showApp();
                    loadChats();
                    setupRealtimeSubscriptions();
                } else {
                    showAuthScreen();
                }
            } catch (error) {
                console.error('Ошибка проверки сессии:', error);
                showNotification('Ошибка проверки сессии. Проверьте настройки Supabase.', 'error');
                showAuthScreen();
            }
        }
        
        async function loadUserProfile(userId) {
            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                
                appState.currentUser = {
                    id: profile.id,
                    email: profile.email,
                    nickname: profile.nickname,
                    avatar_url: profile.avatar_url
                };
                
                updateProfileUI();
            } catch (error) {
                console.error('Ошибка загрузки профиля:', error);
            }
        }
        
        function setupEventListeners() {
            // Авторизация
            document.getElementById('login-tab').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('register-tab').addEventListener('click', () => switchAuthTab('register'));
            document.getElementById('login-btn').addEventListener('click', login);
            document.getElementById('register-btn').addEventListener('click', register);
            
            // Настройки
            document.getElementById('config-toggle').addEventListener('click', openConfigPanel);
            document.getElementById('config-toggle-register').addEventListener('click', openConfigPanel);
            document.getElementById('config-btn').addEventListener('click', openConfigPanel);
            document.getElementById('close-config').addEventListener('click', closeConfigPanel);
            document.getElementById('config-overlay').addEventListener('click', closeConfigPanel);
            document.getElementById('save-config-btn').addEventListener('click', saveConfig);
            document.getElementById('reset-config-btn').addEventListener('click', resetConfig);
            document.getElementById('use-demo-config').addEventListener('click', useDemoConfig);
            
            // Основное приложение
            document.getElementById('menu-btn').addEventListener('click', toggleMenu);
            document.getElementById('profile-btn').addEventListener('click', showProfile);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('back-btn').addEventListener('click', showChats);
            document.getElementById('profile-back-btn').addEventListener('click', showChats);
            
            // Поиск пользователей
            document.getElementById('user-search-input').addEventListener('input', debounce(searchUsers, 300));
            
            // Сообщения
            document.getElementById('message-input').addEventListener('input', autoResizeTextarea);
            document.getElementById('message-input').addEventListener('keydown', handleMessageKeydown);
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('emoji-btn').addEventListener('click', toggleEmojiPicker);
            
            // Профиль
            document.getElementById('avatar-input').addEventListener('change', uploadAvatar);
            document.getElementById('update-nickname-btn').addEventListener('click', updateNickname);
            document.getElementById('nickname-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') updateNickname();
            });
            document.getElementById('notifications-toggle').addEventListener('change', toggleNotifications);
            document.getElementById('test-notification-btn').addEventListener('click', testNotification);
            
            // Emoji picker
            initEmojiPicker();
            
            // Обработка кликов вне emoji picker
            document.addEventListener('click', (e) => {
                const emojiPicker = document.getElementById('emoji-picker');
                if (emojiPicker && !emojiPicker.contains(e.target) && e.target.id !== 'emoji-btn') {
                    emojiPicker.classList.add('hidden');
                }
            });
            
            // Обработка изменения видимости страницы для уведомлений
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    markNotificationsAsRead();
                }
            });
            
            // Обработка Escape для закрытия панели настроек
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeConfigPanel();
                }
            });
        }
        
        function switchAuthTab(tab) {
            document.getElementById('login-tab').classList.toggle('active', tab === 'login');
            document.getElementById('register-tab').classList.toggle('active', tab === 'register');
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
        }
        
        function openConfigPanel() {
            document.getElementById('config-panel').classList.add('open');
            document.getElementById('config-overlay').classList.add('active');
        }
        
        function closeConfigPanel() {
            document.getElementById('config-panel').classList.remove('open');
            document.getElementById('config-overlay').classList.remove('active');
        }
        
        function saveConfig() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if (!url || !key) {
                showNotification('Введите URL и ключ Supabase', 'error');
                return;
            }
            
            // Проверяем формат URL
            if (!url.startsWith('https://') || !url.includes('.supabase.co')) {
                showNotification('Неверный формат Supabase URL. Должен быть: https://your-project.supabase.co', 'error');
                return;
            }
            
            // Проверяем формат ключа (базовая проверка)
            if (!key.startsWith('eyJ')) {
                showNotification('Неверный формат ключа. Должен начинаться с eyJ', 'warning');
            }
            
            localStorage.setItem('supabaseUrl', url);
            localStorage.setItem('supabaseKey', key);
            
            supabaseUrl = url;
            supabaseKey = key;
            
            showNotification('Настройки сохранены. Приложение перезагрузится...', 'success');
            
            // Перезагружаем страницу для применения настроек
            setTimeout(() => location.reload(), 1500);
        }
        
        function resetConfig() {
            if (confirm('Сбросить настройки Supabase к значениям по умолчанию?')) {
                localStorage.removeItem('supabaseUrl');
                localStorage.removeItem('supabaseKey');
                localStorage.removeItem('supabase.auth.token');
                
                showNotification('Настройки сброшены. Приложение перезагрузится...', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        }
        
        function useDemoConfig() {
            // Демо-конфигурация (замените на свою для тестирования)
            const demoUrl = 'https://your-demo-project.supabase.co';
            const demoKey = 'your-demo-anon-key';
            
            if (confirm('Использовать тестовую конфигурацию? Это только для демонстрации.')) {
                document.getElementById('supabase-url').value = demoUrl;
                document.getElementById('supabase-key').value = demoKey;
                showNotification('Тестовые данные загружены. Нажмите "Сохранить"', 'info');
            }
        }
        
        async function login() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorElement = document.getElementById('login-error');
            
            errorElement.classList.add('hidden');
            
            if (!email || !password) {
                errorElement.querySelector('span').textContent = 'Заполните все поля';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (!supabaseClient) {
                errorElement.querySelector('span').textContent = 'Сначала настройте Supabase';
                errorElement.classList.remove('hidden');
                openConfigPanel();
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                await loadUserProfile(data.user.id);
                showApp();
                loadChats();
                setupRealtimeSubscriptions();
                
            } catch (error) {
                console.error('Ошибка входа:', error);
                errorElement.querySelector('span').textContent = error.message || 'Ошибка входа';
                errorElement.classList.remove('hidden');
            }
        }
        
        async function register() {
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const errorElement = document.getElementById('register-error');
            
            errorElement.classList.add('hidden');
            
            if (!email || !password) {
                errorElement.querySelector('span').textContent = 'Заполните все поля';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorElement.querySelector('span').textContent = 'Пароль должен быть минимум 6 символов';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (!supabaseClient) {
                errorElement.querySelector('span').textContent = 'Сначала настройте Supabase';
                errorElement.classList.remove('hidden');
                openConfigPanel();
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        emailRedirectTo: window.location.origin
                    }
                });
                
                if (error) throw error;
                
                if (data.user?.identities?.length === 0) {
                    showNotification('Пользователь с таким email уже существует', 'warning');
                    switchAuthTab('login');
                } else {
                    showNotification('Регистрация успешна! Проверьте email для подтверждения', 'success');
                    switchAuthTab('login');
                }
                
                document.getElementById('register-email').value = '';
                document.getElementById('register-password').value = '';
                
            } catch (error) {
                console.error('Ошибка регистрации:', error);
                errorElement.querySelector('span').textContent = error.message || 'Ошибка регистрации';
                errorElement.classList.remove('hidden');
            }
        }
        
        async function logout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                appState.currentUser = null;
                appState.chats = [];
                appState.users = {};
                
                showAuthScreen();
                showNotification('Вы вышли из системы', 'success');
                
            } catch (error) {
                console.error('Ошибка выхода:', error);
                showNotification('Ошибка выхода', 'error');
            }
        }
        
        function showAuthScreen() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }
        
        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            showChats();
        }
        
        function showChats() {
            document.getElementById('chats-list').classList.remove('hidden');
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById('profile-screen').classList.add('hidden');
            appState.currentScreen = 'chats';
            
            // Очищаем поиск
            document.getElementById('user-search-input').value = '';
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('chats-container').classList.remove('hidden');
        }
        
        function showProfile() {
            document.getElementById('chats-list').classList.add('hidden');
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById('profile-screen').classList.remove('hidden');
            appState.currentScreen = 'profile';
            
            updateProfileUI();
        }
        
        function toggleMenu() {
            showProfile();
        }
        
        function updateProfileUI() {
            if (!appState.currentUser) return;
            
            const user = appState.currentUser;
            
            // Обновляем аватар
            const avatarElement = document.getElementById('profile-avatar');
            if (user.avatar_url) {
                avatarElement.style.backgroundImage = `url('${user.avatar_url}')`;
                avatarElement.style.backgroundSize = 'cover';
                avatarElement.textContent = '';
            } else {
                avatarElement.style.backgroundImage = '';
                avatarElement.textContent = user.nickname ? user.nickname.charAt(1).toUpperCase() : 'U';
            }
            
            // Обновляем информацию
            document.getElementById('profile-name').textContent = user.nickname || user.email;
            document.getElementById('profile-nickname').textContent = user.nickname || 'Не задан';
            document.getElementById('nickname-input').value = user.nickname || '';
            
            // Настройки уведомлений
            document.getElementById('notifications-toggle').checked = appState.notificationsEnabled;
        }
        
        async function loadChats() {
            const loadingElement = document.getElementById('chats-loading');
            const chatsContainer = document.getElementById('chats-container');
            
            try {
                // Загружаем чаты пользователя
                const { data: chats, error } = await supabaseClient
                    .from('chats')
                    .select(`
                        id,
                        created_at,
                        updated_at,
                        chat_members!inner(user_id, profiles!inner(id, nickname, avatar_url)),
                        messages!inner(id, text, created_at, sender_id)
                    `)
                    .order('updated_at', { ascending: false });
                
                if (error) throw error;
                
                // Фильтруем чаты где пользователь является участником
                appState.chats = chats ? chats.filter(chat => 
                    chat.chat_members.some(member => member.user_id === appState.currentUser.id)
                ) : [];
                
                // Создаем кэш пользователей
                appState.chats.forEach(chat => {
                    chat.chat_members.forEach(member => {
                        if (member.user_id !== appState.currentUser.id) {
                            appState.users[member.user_id] = member.profiles;
                        }
                    });
                });
                
                // Отрисовываем чаты
                renderChats();
                
            } catch (error) {
                console.error('Ошибка загрузки чатов:', error);
                showNotification('Ошибка загрузки чатов', 'error');
            } finally {
                loadingElement.classList.add('hidden');
            }
        }
        
        function renderChats() {
            const chatsContainer = document.getElementById('chats-container');
            
            if (appState.chats.length === 0) {
                chatsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p>У вас пока нет чатов</p>
                        <p style="font-size: 14px; margin-top: 8px;">Найдите пользователя чтобы начать общение</p>
                    </div>
                `;
                return;
            }
            
            chatsContainer.innerHTML = appState.chats.map(chat => {
                // Находим собеседника
                const otherMember = chat.chat_members.find(member => 
                    member.user_id !== appState.currentUser.id
                );
                
                if (!otherMember) return '';
                
                const user = appState.users[otherMember.user_id] || otherMember.profiles;
                const lastMessage = chat.messages && chat.messages.length > 0 
                    ? chat.messages[0] 
                    : null;
                
                // Форматируем время
                const time = lastMessage ? formatTime(lastMessage.created_at) : '';
                
                return `
                    <div class="chat-item" data-chat-id="${chat.id}" data-user-id="${user.id}">
                        <div class="avatar" style="${user.avatar_url ? `background-image: url('${user.avatar_url}'); background-size: cover;` : ''}">
                            ${!user.avatar_url ? (user.nickname ? user.nickname.charAt(1).toUpperCase() : 'U') : ''}
                        </div>
                        <div class="chat-info">
                            <div class="chat-name">${user.nickname || 'Пользователь'}</div>
                            <div class="chat-last-message">${lastMessage ? lastMessage.text : 'Нет сообщений'}</div>
                        </div>
                        <div class="chat-time">${time}</div>
                    </div>
                `;
            }).join('');
            
            // Добавляем обработчики кликов
            document.querySelectorAll('.chat-item').forEach(item => {
                item.addEventListener('click', () => openChat(
                    item.dataset.chatId,
                    item.dataset.userId
                ));
            });
        }
        
        async function searchUsers() {
            const query = document.getElementById('user-search-input').value.trim();
            const searchResults = document.getElementById('search-results');
            const chatsContainer = document.getElementById('chats-container');
            
            if (!query) {
                searchResults.classList.add('hidden');
                searchResults.innerHTML = '';
                chatsContainer.classList.remove('hidden');
                return;
            }
            
            try {
                // Ищем пользователей по никнейму
                const { data: users, error } = await supabaseClient
                    .from('profiles')
                    .select('id, nickname, avatar_url, created_at')
                    .ilike('nickname', `%${query}%`)
                    .neq('id', appState.currentUser.id)
                    .limit(10);
                
                if (error) throw error;
                
                searchResults.innerHTML = '';
                
                if (!users || users.length === 0) {
                    searchResults.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                            Пользователи не найдены
                        </div>
                    `;
                } else {
                    users.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'chat-item';
                        userElement.dataset.userId = user.id;
                        userElement.innerHTML = `
                            <div class="avatar" style="${user.avatar_url ? `background-image: url('${user.avatar_url}'); background-size: cover;` : ''}">
                                ${!user.avatar_url ? (user.nickname ? user.nickname.charAt(1).toUpperCase() : 'U') : ''}
                            </div>
                            <div class="chat-info">
                                <div class="chat-name">${user.nickname}</div>
                                <div class="chat-last-message">Нажмите чтобы начать чат</div>
                            </div>
                        `;
                        
                        userElement.addEventListener('click', () => startChat(user.id));
                        searchResults.appendChild(userElement);
                    });
                }
                
                searchResults.classList.remove('hidden');
                chatsContainer.classList.add('hidden');
                
            } catch (error) {
                console.error('Ошибка поиска пользователей:', error);
            }
        }
        
        async function startChat(userId) {
            try {
                // Создаем или получаем существующий чат
                const { data: chatId, error } = await supabaseClient.rpc('create_or_get_chat', {
                    user1_id: appState.currentUser.id,
                    user2_id: userId
                });
                
                if (error) throw error;
                
                // Открываем чат
                openChat(chatId, userId);
                
                // Сбрасываем поиск
                document.getElementById('user-search-input').value = '';
                document.getElementById('search-results').classList.add('hidden');
                document.getElementById('chats-container').classList.remove('hidden');
                
            } catch (error) {
                console.error('Ошибка создания чата:', error);
                showNotification('Ошибка создания чата', 'error');
            }
        }
        
        async function openChat(chatId, userId) {
            appState.currentChat = {
                id: chatId,
                userId: userId
            };
            
            // На мобильных устройствах показываем экран чата
            if (window.innerWidth <= 768) {
                document.getElementById('chats-list').classList.add('hidden');
                document.getElementById('chat-screen').classList.remove('hidden');
            }
            
            // Загружаем информацию о пользователе
            if (!appState.users[userId]) {
                try {
                    const { data: user, error } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('id', userId)
                        .single();
                    
                    if (!error) {
                        appState.users[userId] = user;
                    }
                } catch (error) {
                    console.error('Ошибка загрузки пользователя:', error);
                }
            }
            
            const user = appState.users[userId];
            
            // Обновляем заголовок чата
            document.getElementById('chat-name').textContent = user?.nickname || 'Пользователь';
            
            const chatAvatar = document.getElementById('chat-avatar');
            if (user?.avatar_url) {
                chatAvatar.style.backgroundImage = `url('${user.avatar_url}')`;
                chatAvatar.style.backgroundSize = 'cover';
                chatAvatar.textContent = '';
            } else {
                chatAvatar.style.backgroundImage = '';
                chatAvatar.textContent = user?.nickname ? user.nickname.charAt(1).toUpperCase() : 'U';
            }
            
            // Загружаем сообщения
            loadMessages(chatId);
            
            // Подписываемся на обновления чата
            subscribeToChat(chatId);
        }
        
        async function loadMessages(chatId) {
            const messagesContainer = document.getElementById('messages-container');
            const loadingElement = document.getElementById('messages-loading');
            
            loadingElement.classList.remove('hidden');
            messagesContainer.innerHTML = '';
            
            try {
                // Загружаем сообщения
                const { data: messages, error } = await supabaseClient
                    .from('messages')
                    .select(`
                        *,
                        message_reactions(*),
                        profiles!messages_sender_id_fkey(nickname, avatar_url)
                    `)
                    .eq('chat_id', chatId)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                // Загружаем реакции
                const { data: reactions, error: reactionsError } = await supabaseClient
                    .from('message_reactions')
                    .select('*')
                    .in('message_id', messages.map(m => m.id));
                
                // Отображаем сообщения
                messages.forEach(message => {
                    renderMessage(message, reactions?.filter(r => r.message_id === message.id) || []);
                });
                
                // Прокручиваем вниз
                scrollToBottom();
                
            } catch (error) {
                console.error('Ошибка загрузки сообщений:', error);
                showNotification('Ошибка загрузки сообщений', 'error');
            } finally {
                loadingElement.classList.add('hidden');
            }
        }
        
        function renderMessage(message, reactions) {
            const messagesContainer = document.getElementById('messages-container');
            const isOutgoing = message.sender_id === appState.currentUser.id;
            
            // Группируем реакции по эмодзи
            const reactionCounts = {};
            reactions.forEach(reaction => {
                if (!reactionCounts[reaction.emoji]) {
                    reactionCounts[reaction.emoji] = {
                        count: 0,
                        userReacted: reaction.user_id === appState.currentUser.id
                    };
                }
                reactionCounts[reaction.emoji].count++;
            });
            
            const reactionsHTML = Object.entries(reactionCounts).map(([emoji, data]) => `
                <div class="reaction ${data.userReacted ? 'active' : ''}" 
                     data-message-id="${message.id}"
                     data-emoji="${emoji}"
                     onclick="toggleReaction('${message.id}', '${emoji}')">
                    <span>${emoji}</span>
                    <span>${data.count}</span>
                </div>
            `).join('');
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isOutgoing ? 'message-outgoing' : 'message-incoming'}`;
            messageElement.dataset.messageId = message.id;
            messageElement.innerHTML = `
                <div class="message-bubble">
                    ${escapeHtml(message.text)}
                    <div class="message-time">${formatTime(message.created_at, true)}</div>
                    ${reactionsHTML ? `<div class="message-reactions">${reactionsHTML}</div>` : ''}
                    <div class="message-footer">
                        ${isOutgoing ? '<i class="fas fa-check" style="font-size: 10px; opacity: 0.7;"></i>' : ''}
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
        }
        
        function autoResizeTextarea() {
            const textarea = document.getElementById('message-input');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        function handleMessageKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text || !appState.currentChat) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .insert({
                        chat_id: appState.currentChat.id,
                        sender_id: appState.currentUser.id,
                        text: text
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Очищаем поле ввода
                input.value = '';
                autoResizeTextarea();
                
                // Обновляем время последнего сообщения в чате
                await supabaseClient
                    .from('chats')
                    .update({ updated_at: new Date().toISOString() })
                    .eq('id', appState.currentChat.id);
                
                // Загружаем чаты заново
                loadChats();
                
            } catch (error) {
                console.error('Ошибка отправки сообщения:', error);
                showNotification('Ошибка отправки сообщения', 'error');
            }
        }
        
        async function toggleReaction(messageId, emoji) {
            try {
                // Проверяем, есть ли уже реакция от пользователя
                const { data: existingReaction, error: checkError } = await supabaseClient
                    .from('message_reactions')
                    .select('id')
                    .eq('message_id', messageId)
                    .eq('user_id', appState.currentUser.id)
                    .eq('emoji', emoji)
                    .single();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    throw checkError;
                }
                
                if (existingReaction) {
                    // Удаляем реакцию
                    const { error } = await supabaseClient
                        .from('message_reactions')
                        .delete()
                        .eq('id', existingReaction.id);
                    
                    if (error) throw error;
                } else {
                    // Удаляем предыдущую реакцию пользователя на это сообщение
                    await supabaseClient
                        .from('message_reactions')
                        .delete()
                        .eq('message_id', messageId)
                        .eq('user_id', appState.currentUser.id);
                    
                    // Добавляем новую реакцию
                    const { error } = await supabaseClient
                        .from('message_reactions')
                        .insert({
                            message_id: messageId,
                            user_id: appState.currentUser.id,
                            emoji: emoji
                        });
                    
                    if (error) throw error;
                }
                
            } catch (error) {
                console.error('Ошибка обновления реакции:', error);
            }
        }
        
        function setupRealtimeSubscriptions() {
            if (!supabaseClient) return;
            
            // Подписываемся на новые сообщения
            const messagesChannel = supabaseClient
                .channel('messages')
                .on('postgres_changes', 
                    { 
                        event: 'INSERT', 
                        schema: 'public', 
                        table: 'messages'
                    }, 
                    handleNewMessage
                )
                .subscribe();
            
            // Подписываемся на реакции
            const reactionsChannel = supabaseClient
                .channel('reactions')
                .on('postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'message_reactions'
                    },
                    handleReactionUpdate
                )
                .subscribe();
        }
        
        function subscribeToChat(chatId) {
            if (!supabaseClient) return;
            
            // Удаляем старые подписки на этот чат
            supabaseClient.removeChannel('chat_' + chatId);
            
            // Создаем новую подписку на этот чат
            const chatChannel = supabaseClient
                .channel('chat_' + chatId)
                .on('postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'messages',
                        filter: `chat_id=eq.${chatId}`
                    },
                    handleNewMessage
                )
                .subscribe();
        }
        
        function handleNewMessage(payload) {
            const newMessage = payload.new;
            
            // Если сообщение из текущего открытого чата
            if (appState.currentChat && newMessage.chat_id === appState.currentChat.id) {
                // Проверяем, нет ли уже этого сообщения
                const existingMessage = document.querySelector(`[data-message-id="${newMessage.id}"]`);
                if (existingMessage) return;
                
                // Загружаем полные данные сообщения
                loadFullMessage(newMessage.id);
            }
            
            // Обновляем список чатов
            loadChats();
            
            // Показываем уведомление если вкладка неактивна
            if (document.hidden && appState.notificationsEnabled) {
                showPushNotification(newMessage);
            }
        }
        
        async function loadFullMessage(messageId) {
            try {
                const { data: message, error } = await supabaseClient
                    .from('messages')
                    .select(`
                        *,
                        message_reactions(*),
                        profiles!messages_sender_id_fkey(nickname, avatar_url)
                    `)
                    .eq('id', messageId)
                    .single();
                
                if (error) throw error;
                
                renderMessage(message, message.message_reactions || []);
                scrollToBottom();
                
            } catch (error) {
                console.error('Ошибка загрузки сообщения:', error);
            }
        }
        
        function handleReactionUpdate(payload) {
            const messageElement = document.querySelector(`[data-message-id="${payload.new?.message_id}"]`);
            if (messageElement) {
                // Перезагружаем сообщения для обновления реакций
                if (appState.currentChat) {
                    loadMessages(appState.currentChat.id);
                }
            }
        }
        
        function scrollToBottom() {
            const messagesContainer = document.getElementById('messages-container');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        async function uploadAvatar() {
            const fileInput = document.getElementById('avatar-input');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            // Проверяем тип файла
            const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showNotification('Неподдерживаемый формат файла', 'error');
                return;
            }
            
            // Проверяем размер файла (максимум 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Файл слишком большой (макс. 5MB)', 'error');
                return;
            }
            
            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${appState.currentUser.id}/${Date.now()}.${fileExt}`;
                const filePath = `${fileName}`;
                
                // Загружаем файл в хранилище
                const { error: uploadError } = await supabaseClient.storage
                    .from('avatars')
                    .upload(filePath, file, {
                        upsert: true
                    });
                
                if (uploadError) throw uploadError;
                
                // Получаем публичный URL
                const { data: { publicUrl } } = supabaseClient.storage
                    .from('avatars')
                    .getPublicUrl(filePath);
                
                // Обновляем профиль
                const { error: updateError } = await supabaseClient
                    .from('profiles')
                    .update({ avatar_url: publicUrl })
                    .eq('id', appState.currentUser.id);
                
                if (updateError) throw updateError;
                
                // Обновляем состояние
                appState.currentUser.avatar_url = publicUrl;
                updateProfileUI();
                
                showNotification('Аватар обновлен', 'success');
                
            } catch (error) {
                console.error('Ошибка загрузки аватара:', error);
                showNotification('Ошибка загрузки аватара', 'error');
            }
        }
        
        async function updateNickname() {
            const input = document.getElementById('nickname-input');
            const nickname = input.value.trim();
            const errorElement = document.getElementById('nickname-error');
            
            errorElement.classList.add('hidden');
            
            // Проверяем формат никнейма
            const nicknameRegex = /^@[a-zA-Z0-9_]{3,20}$/;
            if (!nicknameRegex.test(nickname)) {
                errorElement.querySelector('span').textContent = 'Никнейм должен начинаться с @ и содержать 3-20 символов (буквы, цифры, _)';
                errorElement.classList.remove('hidden');
                return;
            }
            
            try {
                // Проверяем уникальность никнейма
                const { data: existingUser, error: checkError } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('nickname', nickname)
                    .neq('id', appState.currentUser.id)
                    .single();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    throw checkError;
                }
                
                if (existingUser) {
                    errorElement.querySelector('span').textContent = 'Этот никнейм уже занят';
                    errorElement.classList.remove('hidden');
                    return;
                }
                
                // Обновляем никнейм
                const { error: updateError } = await supabaseClient
                    .from('profiles')
                    .update({ nickname: nickname })
                    .eq('id', appState.currentUser.id);
                
                if (updateError) throw updateError;
                
                // Обновляем состояние
                appState.currentUser.nickname = nickname;
                updateProfileUI();
                
                showNotification('Никнейм обновлен', 'success');
                
            } catch (error) {
                console.error('Ошибка обновления никнейма:', error);
                errorElement.querySelector('span').textContent = error.message || 'Ошибка обновления никнейма';
                errorElement.classList.remove('hidden');
            }
        }
        
        function checkNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Браузер не поддерживает уведомления');
                return;
            }
            
            appState.notificationPermission = Notification.permission;
            
            if (appState.notificationPermission === 'granted') {
                appState.notificationsEnabled = true;
            } else if (appState.notificationPermission === 'denied') {
                appState.notificationsEnabled = false;
            }
        }
        
        async function toggleNotifications() {
            const toggle = document.getElementById('notifications-toggle');
            
            if (!('Notification' in window)) {
                showNotification('Браузер не поддерживает уведомления', 'error');
                toggle.checked = false;
                return;
            }
            
            if (Notification.permission === 'denied') {
                showNotification('Разрешение на уведомления было отклонено. Измените настройки браузера.', 'error');
                toggle.checked = false;
                return;
            }
            
            if (Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                appState.notificationPermission = permission;
                
                if (permission === 'granted') {
                    appState.notificationsEnabled = true;
                    toggle.checked = true;
                    showNotification('Уведомления включены', 'success');
                } else {
                    appState.notificationsEnabled = false;
                    toggle.checked = false;
                    showNotification('Уведомления отключены', 'warning');
                }
            } else {
                appState.notificationsEnabled = toggle.checked;
            }
        }
        
        function showPushNotification(message) {
            if (!appState.notificationsEnabled || !message) return;
            
            // Получаем информацию об отправителе
            const sender = appState.users[message.sender_id];
            const senderName = sender?.nickname || 'Пользователь';
            
            const notification = new Notification('Новое сообщение', {
                body: `${senderName}: ${message.text.substring(0, 100)}`,
                icon: sender?.avatar_url || '/favicon.ico',
                tag: 'message-' + message.id
            });
            
            notification.onclick = function() {
                window.focus();
                this.close();
                
                // Открываем соответствующий чат
                if (appState.currentChat?.id !== message.chat_id) {
                    openChat(message.chat_id, message.sender_id);
                }
            };
        }
        
        function testNotification() {
            if (!appState.notificationsEnabled) {
                showNotification('Включите уведомления в настройках', 'warning');
                return;
            }
            
            if (Notification.permission === 'granted') {
                const notification = new Notification('Тестовое уведомление', {
                    body: 'Это тестовое уведомление от Supabase Messenger',
                    icon: appState.currentUser?.avatar_url || '/favicon.ico'
                });
                
                notification.onclick = function() {
                    window.focus();
                    this.close();
                };
            }
        }
        
        function markNotificationsAsRead() {
            // Можно реализовать отметку уведомлений как прочитанных
        }
        
        function initEmojiPicker() {
            const emojiPicker = document.getElementById('emoji-picker');
            const emojis = ['👍', '❤️', '😂', '😮', '😢', '😡', '🙂', '😎', '🤔', '👏', '🎉', '🔥'];
            
            emojiPicker.querySelector('div').innerHTML = emojis.map(emoji => `
                <button class="btn btn-text" style="font-size: 24px; padding: 5px;" onclick="insertEmoji('${emoji}')">${emoji}</button>
            `).join('');
        }
        
        function toggleEmojiPicker() {
            const emojiPicker = document.getElementById('emoji-picker');
            emojiPicker.classList.toggle('hidden');
            
            // Позиционируем эмодзи пикер
            if (!emojiPicker.classList.contains('hidden')) {
                const emojiBtn = document.getElementById('emoji-btn');
                const rect = emojiBtn.getBoundingClientRect();
                
                emojiPicker.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
                emojiPicker.style.right = (window.innerWidth - rect.right) + 'px';
            }
        }
        
        function insertEmoji(emoji) {
            const input = document.getElementById('message-input');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            
            input.value = input.value.substring(0, start) + emoji + input.value.substring(end);
            input.focus();
            input.setSelectionRange(start + emoji.length, start + emoji.length);
            
            autoResizeTextarea();
            
            // Скрываем пикер
            document.getElementById('emoji-picker').classList.add('hidden');
        }
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications-container');
            const id = 'notification-' + Date.now();
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            const notification = document.createElement('div');
            notification.id = id;
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${icons[type]}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${type === 'success' ? 'Успешно' : type === 'error' ? 'Ошибка' : type === 'warning' ? 'Внимание' : 'Информация'}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="closeNotification('${id}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            // Автоматическое закрытие через 5 секунд
            setTimeout(() => closeNotification(id), 5000);
        }
        
        function closeNotification(id) {
            const notification = document.getElementById(id);
            if (notification) {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }
        }
        
        // Вспомогательные функции
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function formatTime(timestamp, includeSeconds = false) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) {
                return 'только что';
            } else if (diffMins < 60) {
                return `${diffMins} мин назад`;
            } else if (diffHours < 24) {
                return `${diffHours} ч назад`;
            } else if (diffDays < 7) {
                return `${diffDays} дн назад`;
            } else {
                return date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'short',
                    year: diffDays > 365 ? 'numeric' : undefined
                });
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Экспортируем функции для использования в HTML
        window.insertEmoji = insertEmoji;
        window.toggleReaction = toggleReaction;
        window.closeNotification = closeNotification;
    </script>
</body>
</html>
