<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Supabase Messenger</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* –°–±—Ä–æ—Å –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-color: #0084ff;
            --primary-dark: #0066cc;
            --bg-color: #ffffff;
            --bg-secondary: #f0f2f5;
            --bg-tertiary: #e4e6eb;
            --text-primary: #050505;
            --text-secondary: #65676b;
            --border-color: #ddd;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
            --radius-sm: 8px;
            --header-height: 56px;
            --footer-height: 60px;
            --transition: all 0.2s ease;
            --success-color: #31a24c;
            --error-color: #f02849;
            --warning-color: #f7b928;
            --reaction-bg: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            white-space: nowrap;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: #d8dadf;
        }

        .btn-text {
            background: none;
            color: var(--primary-color);
            padding: 8px;
        }

        .btn-text:hover {
            background-color: rgba(0, 132, 255, 0.1);
        }

        .input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 15px;
            transition: var(--transition);
            background-color: white;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 132, 255, 0.2);
        }

        .card {
            background-color: var(--bg-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            width: 100%;
            max-width: 400px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background-color: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 16px;
        }

        .avatar-lg {
            width: 80px;
            height: 80px;
            font-size: 24px;
        }

        .hidden {
            display: none !important;
        }

        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        #auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background-color: var(--bg-secondary);
        }

        .auth-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 400px;
        }

        .auth-tabs {
            display: flex;
            background-color: white;
            border-radius: var(--radius-sm);
            padding: 4px;
            margin-bottom: 10px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 600;
            transition: var(--transition);
        }

        .auth-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .form-error {
            color: var(--error-color);
            font-size: 14px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω */
        #app {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            height: var(--header-height);
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-weight: 700;
            font-size: 20px;
            color: var(--primary-color);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        #chats-list {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
        }

        .chats-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        #user-search-input {
            padding-left: 40px;
        }

        .chats-container {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
        }

        .chat-item:hover {
            background-color: var(--bg-secondary);
        }

        .chat-item.active {
            background-color: rgba(0, 132, 255, 0.1);
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-last-message {
            color: var(--text-secondary);
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-time {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        /* –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ */
        #chat-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-secondary);
            height: 100%;
        }

        .chat-header {
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .chat-header-status {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            display: flex;
            max-width: 80%;
            animation: messageAppear 0.2s ease;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-outgoing {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            word-break: break-word;
            position: relative;
        }

        .message-outgoing .message-bubble {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-incoming .message-bubble {
            background-color: white;
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message-time {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.7;
            text-align: right;
        }

        .message-reactions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .reaction {
            background-color: var(--reaction-bg);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .reaction:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .reaction.active {
            background-color: rgba(0, 132, 255, 0.15);
        }

        .message-footer {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .message-input-container {
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #message-input {
            flex: 1;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            border: none;
            outline: none;
            font-size: 15px;
            font-family: inherit;
            padding: 8px 0;
            line-height: 1.4;
        }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        #profile-screen {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            overflow-y: auto;
        }

        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .avatar-upload {
            position: relative;
            cursor: pointer;
        }

        .avatar-upload:hover .avatar-overlay {
            opacity: 1;
        }

        .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            opacity: 0;
            transition: var(--transition);
        }

        .profile-info {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: white;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 350px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .notification-success .notification-icon {
            background-color: var(--success-color);
        }

        .notification-error .notification-icon {
            background-color: var(--error-color);
        }

        .notification-warning .notification-icon {
            background-color: var(--warning-color);
        }

        .notification-info .notification-icon {
            background-color: var(--primary-color);
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 132, 255, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        @media (max-width: 768px) {
            .main-content {
                position: relative;
            }
            
            #chats-list, #chat-screen, #profile-screen {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                transition: transform 0.3s ease;
            }
            
            #chat-screen.hidden {
                transform: translateX(100%);
            }
            
            #profile-screen.hidden {
                transform: translateX(100%);
            }
            
            .chat-item {
                padding: 10px 12px;
            }
        }

        @media (min-width: 769px) {
            #chats-list {
                width: 360px;
                border-right: 1px solid var(--border-color);
            }
            
            #chat-screen {
                width: calc(100% - 360px);
            }
        }

        /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .config-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 12px rgba(0,0,0,0.1);
            padding: 20px;
            transition: right 0.3s ease;
            z-index: 1001;
            overflow-y: auto;
        }

        .config-panel.open {
            right: 0;
        }

        .config-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .config-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="auth-screen">
        <div class="auth-container card">
            <div class="auth-tabs">
                <div class="auth-tab active" id="login-tab">–í—Ö–æ–¥</div>
                <div class="auth-tab" id="register-tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            </div>
            
            <div id="login-form" class="auth-form">
                <div class="form-group">
                    <label class="form-label" for="login-email">Email</label>
                    <input type="email" id="login-email" class="input" placeholder="–í–∞—à email">
                </div>
                <div class="form-group">
                    <label class="form-label" for="login-password">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="login-password" class="input" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å">
                </div>
                <div id="login-error" class="form-error hidden">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞</span>
                </div>
                <button id="login-btn" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                <button id="config-toggle" class="btn btn-text" style="margin-top: 10px;">
                    <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
            </div>
            
            <div id="register-form" class="auth-form hidden">
                <div class="form-group">
                    <label class="form-label" for="register-email">Email</label>
                    <input type="email" id="register-email" class="input" placeholder="–í–∞—à email">
                </div>
                <div class="form-group">
                    <label class="form-label" for="register-password">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="register-password" class="input" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
                </div>
                <div id="register-error" class="form-error hidden">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</span>
                </div>
                <button id="register-btn" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button id="config-toggle-register" class="btn btn-text" style="margin-top: 10px;">
                    <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
            </div>
        </div>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="config-overlay" class="config-overlay"></div>
    <div id="config-panel" class="config-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase</h2>
            <button id="close-config" class="btn btn-text">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div style="margin-bottom: 20px; padding: 15px; background-color: var(--bg-secondary); border-radius: var(--radius-sm); font-size: 14px;">
            <p style="margin-bottom: 10px; font-weight: 600;">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</p>
            <ol style="padding-left: 20px; margin-bottom: 10px;">
                <li>–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ <a href="https://supabase.com" target="_blank">Supabase</a></li>
                <li>–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç –∏–∑ schema.sql</li>
                <li>–í—Å—Ç–∞–≤—å—Ç–µ URL –∏ anon –∫–ª—é—á –Ω–∏–∂–µ</li>
            </ol>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="supabase-url">Supabase Project URL</label>
            <input type="text" id="supabase-url" class="input" placeholder="https://your-project.supabase.co">
        </div>
        <div class="form-group">
            <label class="form-label" for="supabase-key">Supabase anon key</label>
            <input type="text" id="supabase-key" class="input" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">
                –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è.
            </p>
            <button id="save-config-btn" class="btn btn-primary" style="width: 100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
            <button id="reset-config-btn" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 15px;">–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h3>
            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 15px;">
                –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è):
            </p>
            <button id="use-demo-config" class="btn btn-secondary" style="width: 100%;">
                –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            </button>
            <p style="font-size: 12px; color: var(--warning-color); margin-top: 10px;">
                –í–Ω–∏–º–∞–Ω–∏–µ: —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            </p>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button id="menu-btn" class="btn btn-text">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="header-title">Supabase Messenger</h1>
            </div>
            <div class="header-actions">
                <button id="config-btn" class="btn btn-text" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                    <i class="fas fa-cog"></i>
                </button>
                <button id="profile-btn" class="btn btn-text" title="–ü—Ä–æ—Ñ–∏–ª—å">
                    <i class="fas fa-user"></i>
                </button>
                <button id="logout-btn" class="btn btn-text" title="–í—ã–π—Ç–∏">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="main-content">
            <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
            <div id="chats-list">
                <div class="chats-header">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="user-search-input" class="input" placeholder="–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ @nickname">
                    </div>
                </div>
                <div id="search-results" class="chats-container hidden"></div>
                <div id="chats-container" class="chats-container">
                    <div class="loading" id="chats-loading">
                        <div class="spinner"></div>
                    </div>
                    <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
            <div id="chat-screen" class="hidden">
                <div class="chat-header">
                    <button id="back-btn" class="btn btn-text">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div id="chat-avatar" class="avatar"></div>
                    <div class="chat-header-info">
                        <div id="chat-name" class="chat-header-name"></div>
                        <div id="chat-status" class="chat-header-status">–í —Å–µ—Ç–∏</div>
                    </div>
                </div>
                
                <div id="messages-container" class="messages-container">
                    <div class="loading" id="messages-loading">
                        <div class="spinner"></div>
                    </div>
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                
                <div class="message-input-container">
                    <button id="emoji-btn" class="btn btn-text">
                        <i class="far fa-smile"></i>
                    </button>
                    <textarea id="message-input" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                    <button id="send-btn" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—è -->
            <div id="profile-screen" class="hidden">
                <button id="profile-back-btn" class="btn btn-text" style="align-self: flex-start;">
                    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                </button>
                
                <div class="profile-header">
                    <div class="avatar-upload">
                        <div id="profile-avatar" class="avatar avatar-lg"></div>
                        <div class="avatar-overlay">
                            <i class="fas fa-camera"></i>
                        </div>
                        <input type="file" id="avatar-input" accept="image/jpeg,image/png,image/webp" class="hidden">
                    </div>
                    <h2 id="profile-name"></h2>
                    <div id="profile-nickname" style="color: var(--text-secondary);"></div>
                </div>
                
                <div class="profile-info card">
                    <div class="form-group">
                        <label class="form-label" for="nickname-input">–ù–∏–∫–Ω–µ–π–º (@nickname)</label>
                        <input type="text" id="nickname-input" class="input" placeholder="@username">
                        <small style="color: var(--text-secondary); margin-top: 5px;">–ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _</small>
                    </div>
                    <div id="nickname-error" class="form-error hidden">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∏–∫–Ω–µ–π–º–∞</span>
                    </div>
                    <button id="update-nickname-btn" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º</button>
                </div>
                
                <div class="card" style="width: 100%;">
                    <h3 style="margin-bottom: 15px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <span>Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                        <label class="switch">
                            <input type="checkbox" id="notifications-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button id="test-notification-btn" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-bell"></i> –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="notifications-container"></div>
    
    <!-- Emoji picker (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π) -->
    <div id="emoji-picker" class="hidden" style="position: fixed; bottom: 80px; right: 20px; background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 10px; z-index: 1000; width: 200px; max-height: 200px; overflow-y: auto;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            <!-- Emoji –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ============================================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø SUPABASE (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò)
        // ============================================
        
        // –ü–û–õ–£–ß–ò–¢–ï –í –ü–†–û–ï–ö–¢–ï SUPABASE: Settings ‚Üí API
        const DEFAULT_SUPABASE_URL = 'https://geoojvchpycmsbdsmytu.supabase.co';  // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π URL
        const DEFAULT_SUPABASE_KEY = 'sb_publishable_9wNJrGlNHzidAHktXChLXw_nUqvt9NN';  // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π –∫–ª—é—á
        
        // ============================================
        // –ö–û–ù–ï–¶ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
        // ============================================
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ localStorage –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let supabaseUrl = localStorage.getItem('supabaseUrl') || DEFAULT_SUPABASE_URL;
        let supabaseKey = localStorage.getItem('supabaseKey') || DEFAULT_SUPABASE_KEY;
        
        let supabaseClient = null;
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const appState = {
            currentUser: null,
            currentChat: null,
            currentScreen: 'chats',
            chats: [],
            users: {},
            notificationsEnabled: false,
            notificationPermission: null
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initApp);
        
        async function initApp() {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            checkNotificationPermission();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ —Ñ–æ—Ä–º—É
            loadConfigToForm();
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Supabase
            if (supabaseUrl && supabaseKey) {
                initSupabase();
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                showNotification('–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Supabase –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã', 'warning');
                setTimeout(() => openConfigPanel(), 1000);
            }
        }
        
        function loadConfigToForm() {
            document.getElementById('supabase-url').value = supabaseUrl;
            document.getElementById('supabase-key').value = supabaseKey;
        }
        
        function initSupabase() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Supabase –∑–∞–≥—Ä—É–∂–µ–Ω–∞
                if (typeof supabase === 'undefined') {
                    throw new Error('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Supabase –∫–ª–∏–µ–Ω—Ç
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: true
                    },
                    realtime: {
                        params: {
                            eventsPerSecond: 10
                        }
                    }
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é
                checkSession();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:', error);
                showNotification('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.', 'error');
                openConfigPanel();
            }
        }
        
        async function checkSession() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                if (error) throw error;
                
                if (session) {
                    await loadUserProfile(session.user.id);
                    showApp();
                    loadChats();
                    setupRealtimeSubscriptions();
                } else {
                    showAuthScreen();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–∏:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase.', 'error');
                showAuthScreen();
            }
        }
        
        async function loadUserProfile(userId) {
            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) {
                    // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
                    if (error.code === 'PGRST116') {
                        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                        if (userError) throw userError;
                        
                        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                        const { data: newProfile, error: insertError } = await supabaseClient
                            .from('profiles')
                            .insert({
                                id: user.id,
                                email: user.email,
                                nickname: '@user_' + Math.random().toString(36).substring(2, 10)
                            })
                            .select()
                            .single();
                        
                        if (insertError) throw insertError;
                        
                        appState.currentUser = {
                            id: newProfile.id,
                            email: newProfile.email,
                            nickname: newProfile.nickname,
                            avatar_url: newProfile.avatar_url
                        };
                    } else {
                        throw error;
                    }
                } else {
                    appState.currentUser = {
                        id: profile.id,
                        email: profile.email,
                        nickname: profile.nickname,
                        avatar_url: profile.avatar_url
                    };
                }
                
                updateProfileUI();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message, 'error');
            }
        }
        
        function setupEventListeners() {
            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            document.getElementById('login-tab').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('register-tab').addEventListener('click', () => switchAuthTab('register'));
            document.getElementById('login-btn').addEventListener('click', login);
            document.getElementById('register-btn').addEventListener('click', register);
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            document.getElementById('config-toggle').addEventListener('click', openConfigPanel);
            document.getElementById('config-toggle-register').addEventListener('click', openConfigPanel);
            document.getElementById('config-btn').addEventListener('click', openConfigPanel);
            document.getElementById('close-config').addEventListener('click', closeConfigPanel);
            document.getElementById('config-overlay').addEventListener('click', closeConfigPanel);
            document.getElementById('save-config-btn').addEventListener('click', saveConfig);
            document.getElementById('reset-config-btn').addEventListener('click', resetConfig);
            document.getElementById('use-demo-config').addEventListener('click', useDemoConfig);
            
            // –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            document.getElementById('menu-btn').addEventListener('click', toggleMenu);
            document.getElementById('profile-btn').addEventListener('click', showProfile);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('back-btn').addEventListener('click', showChats);
            document.getElementById('profile-back-btn').addEventListener('click', showChats);
            
            // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            document.getElementById('user-search-input').addEventListener('input', debounce(searchUsers, 300));
            
            // –°–æ–æ–±—â–µ–Ω–∏—è
            document.getElementById('message-input').addEventListener('input', autoResizeTextarea);
            document.getElementById('message-input').addEventListener('keydown', handleMessageKeydown);
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('emoji-btn').addEventListener('click', toggleEmojiPicker);
            
            // –ü—Ä–æ—Ñ–∏–ª—å
            document.getElementById('avatar-input').addEventListener('change', uploadAvatar);
            document.getElementById('update-nickname-btn').addEventListener('click', updateNickname);
            document.getElementById('nickname-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') updateNickname();
            });
            document.getElementById('notifications-toggle').addEventListener('change', toggleNotifications);
            document.getElementById('test-notification-btn').addEventListener('click', testNotification);
            
            // Emoji picker
            initEmojiPicker();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –≤–Ω–µ emoji picker
            document.addEventListener('click', (e) => {
                const emojiPicker = document.getElementById('emoji-picker');
                if (emojiPicker && !emojiPicker.contains(e.target) && e.target.id !== 'emoji-btn') {
                    emojiPicker.classList.add('hidden');
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    markNotificationsAsRead();
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Escape –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeConfigPanel();
                }
            });
        }
        
        function switchAuthTab(tab) {
            document.getElementById('login-tab').classList.toggle('active', tab === 'login');
            document.getElementById('register-tab').classList.toggle('active', tab === 'register');
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
        }
        
        function openConfigPanel() {
            document.getElementById('config-panel').classList.add('open');
            document.getElementById('config-overlay').classList.add('active');
        }
        
        function closeConfigPanel() {
            document.getElementById('config-panel').classList.remove('open');
            document.getElementById('config-overlay').classList.remove('active');
        }
        
        function saveConfig() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if (!url || !key) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ URL –∏ –∫–ª—é—á Supabase', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç URL
            if (!url.startsWith('https://') || !url.includes('.supabase.co')) {
                showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Supabase URL. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å: https://your-project.supabase.co', 'error');
                return;
            }
            
            localStorage.setItem('supabaseUrl', url);
            localStorage.setItem('supabaseKey', key);
            
            supabaseUrl = url;
            supabaseKey = key;
            
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è...', 'success');
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
            setTimeout(() => location.reload(), 1500);
        }
        
        function resetConfig() {
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
                localStorage.removeItem('supabaseUrl');
                localStorage.removeItem('supabaseKey');
                localStorage.removeItem('supabase.auth.token');
                
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è...', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        }
        
        function useDemoConfig() {
            // –î–µ–º–æ-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ—é –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
            const demoUrl = 'https://your-demo-project.supabase.co';
            const demoKey = 'your-demo-anon-key';
            
            if (confirm('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é? –≠—Ç–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏.')) {
                document.getElementById('supabase-url').value = demoUrl;
                document.getElementById('supabase-key').value = demoKey;
                showNotification('–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"', 'info');
            }
        }
        
        async function login() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorElement = document.getElementById('login-error');
            
            errorElement.classList.add('hidden');
            
            if (!email || !password) {
                errorElement.querySelector('span').textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (!supabaseClient) {
                errorElement.querySelector('span').textContent = '–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Supabase';
                errorElement.classList.remove('hidden');
                openConfigPanel();
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                await loadUserProfile(data.user.id);
                showApp();
                loadChats();
                setupRealtimeSubscriptions();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                errorElement.querySelector('span').textContent = error.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                errorElement.classList.remove('hidden');
            }
        }
        
        async function register() {
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const errorElement = document.getElementById('register-error');
            
            errorElement.classList.add('hidden');
            
            if (!email || !password) {
                errorElement.querySelector('span').textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorElement.querySelector('span').textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (!supabaseClient) {
                errorElement.querySelector('span').textContent = '–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Supabase';
                errorElement.classList.remove('hidden');
                openConfigPanel();
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        emailRedirectTo: window.location.origin
                    }
                });
                
                if (error) throw error;
                
                if (data.user?.identities?.length === 0) {
                    showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'warning');
                    switchAuthTab('login');
                } else {
                    showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è', 'success');
                    switchAuthTab('login');
                }
                
                document.getElementById('register-email').value = '';
                document.getElementById('register-password').value = '';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                errorElement.querySelector('span').textContent = error.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
                errorElement.classList.remove('hidden');
            }
        }
        
        async function logout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                appState.currentUser = null;
                appState.chats = [];
                appState.users = {};
                
                showAuthScreen();
                showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞', 'error');
            }
        }
        
        function showAuthScreen() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }
        
        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            showChats();
        }
        
        function showChats() {
            document.getElementById('chats-list').classList.remove('hidden');
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById('profile-screen').classList.add('hidden');
            appState.currentScreen = 'chats';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫
            document.getElementById('user-search-input').value = '';
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('chats-container').classList.remove('hidden');
        }
        
        function showProfile() {
            document.getElementById('chats-list').classList.add('hidden');
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById('profile-screen').classList.remove('hidden');
            appState.currentScreen = 'profile';
            
            updateProfileUI();
        }
        
        function toggleMenu() {
            showProfile();
        }
        
        function updateProfileUI() {
            if (!appState.currentUser) return;
            
            const user = appState.currentUser;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä
            const avatarElement = document.getElementById('profile-avatar');
            if (user.avatar_url) {
                avatarElement.style.backgroundImage = `url('${user.avatar_url}')`;
                avatarElement.style.backgroundSize = 'cover';
                avatarElement.textContent = '';
            } else {
                avatarElement.style.backgroundImage = '';
                avatarElement.textContent = user.nickname ? user.nickname.charAt(1).toUpperCase() : 'U';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            document.getElementById('profile-name').textContent = user.nickname || user.email;
            document.getElementById('profile-nickname').textContent = user.nickname || '–ù–µ –∑–∞–¥–∞–Ω';
            document.getElementById('nickname-input').value = user.nickname || '';
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            document.getElementById('notifications-toggle').checked = appState.notificationsEnabled;
        }
        
        async function loadChats() {
            const loadingElement = document.getElementById('chats-loading');
            const chatsContainer = document.getElementById('chats-container');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const { data: chats, error } = await supabaseClient
                    .from('chats')
                    .select(`
                        id,
                        created_at,
                        updated_at,
                        chat_members!inner(user_id, profiles!inner(id, nickname, avatar_url))
                    `)
                    .order('updated_at', { ascending: false });
                
                if (error) throw error;
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —á–∞—Ç—ã –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–º
                appState.chats = chats ? chats.filter(chat => 
                    chat.chat_members.some(member => member.user_id === appState.currentUser.id)
                ) : [];
                
                // –ü–æ–ª—É—á–∞–µ–º ID —á–∞—Ç–æ–≤
                const chatIds = appState.chats.map(chat => chat.id);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —ç—Ç–∏—Ö —á–∞—Ç–æ–≤
                let lastMessages = {};
                if (chatIds.length > 0) {
                    const { data: messages, error: messagesError } = await supabaseClient
                        .from('messages')
                        .select(`
                            id,
                            chat_id,
                            text,
                            created_at,
                            sender_id
                        `)
                        .in('chat_id', chatIds)
                        .order('created_at', { ascending: false });
                    
                    if (!messagesError && messages) {
                        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ chat_id –∏ –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ (–ø–æ—Å–ª–µ–¥–Ω–µ–µ) —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞
                        messages.forEach(msg => {
                            if (!lastMessages[msg.chat_id]) {
                                lastMessages[msg.chat_id] = msg;
                            }
                        });
                    }
                }
                
                // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∂–¥–æ–º—É —á–∞—Ç—É
                appState.chats.forEach(chat => {
                    chat.last_message = lastMessages[chat.id] || null;
                });
                
                // –°–æ–∑–¥–∞–µ–º –∫—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                appState.chats.forEach(chat => {
                    chat.chat_members.forEach(member => {
                        if (member.user_id !== appState.currentUser.id) {
                            appState.users[member.user_id] = member.profiles;
                        }
                    });
                });
                
                // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —á–∞—Ç—ã
                renderChats();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤: ' + error.message, 'error');
            } finally {
                loadingElement.classList.add('hidden');
            }
        }
        
        function renderChats() {
            const chatsContainer = document.getElementById('chats-container');
            
            if (appState.chats.length === 0) {
                chatsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</p>
                        <p style="font-size: 14px; margin-top: 8px;">–ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                    </div>
                `;
                return;
            }
            
            chatsContainer.innerHTML = appState.chats.map(chat => {
                // –ù–∞—Ö–æ–¥–∏–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                const otherMember = chat.chat_members.find(member => 
                    member.user_id !== appState.currentUser.id
                );
                
                if (!otherMember) return '';
                
                const user = appState.users[otherMember.user_id] || otherMember.profiles;
                const lastMessage = chat.last_message;
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
                const time = lastMessage ? formatTime(lastMessage.created_at) : '';
                
                return `
                    <div class="chat-item" data-chat-id="${chat.id}" data-user-id="${user.id}">
                        <div class="avatar" style="${user.avatar_url ? `background-image: url('${user.avatar_url}'); background-size: cover;` : ''}">
                            ${!user.avatar_url ? (user.nickname ? user.nickname.charAt(1).toUpperCase() : 'U') : ''}
                        </div>
                        <div class="chat-info">
                            <div class="chat-name">${user.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                            <div class="chat-last-message">${lastMessage ? (lastMessage.text.length > 50 ? lastMessage.text.substring(0, 50) + '...' : lastMessage.text) : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                        </div>
                        <div class="chat-time">${time}</div>
                    </div>
                `;
            }).join('');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
            document.querySelectorAll('.chat-item').forEach(item => {
                item.addEventListener('click', () => openChat(
                    item.dataset.chatId,
                    item.dataset.userId
                ));
            });
        }
        
        async function searchUsers() {
            const query = document.getElementById('user-search-input').value.trim();
            const searchResults = document.getElementById('search-results');
            const chatsContainer = document.getElementById('chats-container');
            
            if (!query) {
                searchResults.classList.add('hidden');
                searchResults.innerHTML = '';
                chatsContainer.classList.remove('hidden');
                return;
            }
            
            try {
                // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –Ω–∏–∫–Ω–µ–π–º—É
                const { data: users, error } = await supabaseClient
                    .from('profiles')
                    .select('id, nickname, avatar_url, created_at')
                    .ilike('nickname', `%${query}%`)
                    .neq('id', appState.currentUser.id)
                    .limit(10);
                
                if (error) throw error;
                
                searchResults.innerHTML = '';
                
                if (!users || users.length === 0) {
                    searchResults.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                        </div>
                    `;
                } else {
                    users.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'chat-item';
                        userElement.dataset.userId = user.id;
                        userElement.innerHTML = `
                            <div class="avatar" style="${user.avatar_url ? `background-image: url('${user.avatar_url}'); background-size: cover;` : ''}">
                                ${!user.avatar_url ? (user.nickname ? user.nickname.charAt(1).toUpperCase() : 'U') : ''}
                            </div>
                            <div class="chat-info">
                                <div class="chat-name">${user.nickname}</div>
                                <div class="chat-last-message">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç</div>
                            </div>
                        `;
                        
                        userElement.addEventListener('click', () => startChat(user.id));
                        searchResults.appendChild(userElement);
                    });
                }
                
                searchResults.classList.remove('hidden');
                chatsContainer.classList.add('hidden');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            }
        }
        
        async function startChat(userId) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ userId —è–≤–ª—è–µ—Ç—Å—è UUID
                if (!isValidUUID(userId) || !isValidUUID(appState.currentUser.id)) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
                
                // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç
                const { data: chatId, error } = await supabaseClient.rpc('create_or_get_chat', {
                    user1_id: appState.currentUser.id,
                    user2_id: userId
                });
                
                if (error) throw error;
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
                openChat(chatId, userId);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫
                document.getElementById('user-search-input').value = '';
                document.getElementById('search-results').classList.add('hidden');
                document.getElementById('chats-container').classList.remove('hidden');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞: ' + error.message, 'error');
            }
        }
        
        function isValidUUID(uuid) {
            const regex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            return regex.test(uuid);
        }
        
        async function openChat(chatId, userId) {
            appState.currentChat = {
                id: chatId,
                userId: userId
            };
            
            // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —á–∞—Ç–∞
            if (window.innerWidth <= 768) {
                document.getElementById('chats-list').classList.add('hidden');
                document.getElementById('chat-screen').classList.remove('hidden');
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            if (!appState.users[userId]) {
                try {
                    const { data: user, error } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('id', userId)
                        .single();
                    
                    if (!error) {
                        appState.users[userId] = user;
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                }
            }
            
            const user = appState.users[userId];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
            document.getElementById('chat-name').textContent = user?.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            
            const chatAvatar = document.getElementById('chat-avatar');
            if (user?.avatar_url) {
                chatAvatar.style.backgroundImage = `url('${user.avatar_url}')`;
                chatAvatar.style.backgroundSize = 'cover';
                chatAvatar.textContent = '';
            } else {
                chatAvatar.style.backgroundImage = '';
                chatAvatar.textContent = user?.nickname ? user.nickname.charAt(1).toUpperCase() : 'U';
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            loadMessages(chatId);
            
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞
            subscribeToChat(chatId);
        }
        
        async function loadMessages(chatId) {
            const messagesContainer = document.getElementById('messages-container');
            const loadingElement = document.getElementById('messages-loading');
            
            loadingElement.classList.remove('hidden');
            messagesContainer.innerHTML = '';
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                const { data: messages, error } = await supabaseClient
                    .from('messages')
                    .select(`
                        *,
                        message_reactions(*),
                        profiles!messages_sender_id_fkey(nickname, avatar_url)
                    `)
                    .eq('chat_id', chatId)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                messages.forEach(message => {
                    renderMessage(message, message.message_reactions || []);
                });
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                scrollToBottom();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π', 'error');
            } finally {
                loadingElement.classList.add('hidden');
            }
        }
        
        function renderMessage(message, reactions) {
            const messagesContainer = document.getElementById('messages-container');
            const isOutgoing = message.sender_id === appState.currentUser.id;
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ä–µ–∞–∫—Ü–∏–∏ –ø–æ —ç–º–æ–¥–∑–∏
            const reactionCounts = {};
            reactions.forEach(reaction => {
                if (!reactionCounts[reaction.emoji]) {
                    reactionCounts[reaction.emoji] = {
                        count: 0,
                        userReacted: reaction.user_id === appState.currentUser.id
                    };
                }
                reactionCounts[reaction.emoji].count++;
            });
            
            const reactionsHTML = Object.entries(reactionCounts).map(([emoji, data]) => `
                <div class="reaction ${data.userReacted ? 'active' : ''}" 
                     data-message-id="${message.id}"
                     data-emoji="${emoji}"
                     onclick="toggleReaction('${message.id}', '${emoji}')">
                    <span>${emoji}</span>
                    <span>${data.count}</span>
                </div>
            `).join('');
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isOutgoing ? 'message-outgoing' : 'message-incoming'}`;
            messageElement.dataset.messageId = message.id;
            messageElement.innerHTML = `
                <div class="message-bubble">
                    ${escapeHtml(message.text)}
                    <div class="message-time">${formatTime(message.created_at, true)}</div>
                    ${reactionsHTML ? `<div class="message-reactions">${reactionsHTML}</div>` : ''}
                    <div class="message-footer">
                        ${isOutgoing ? '<i class="fas fa-check" style="font-size: 10px; opacity: 0.7;"></i>' : ''}
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
        }
        
        function autoResizeTextarea() {
            const textarea = document.getElementById('message-input');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        function handleMessageKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text || !appState.currentChat) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .insert({
                        chat_id: appState.currentChat.id,
                        sender_id: appState.currentUser.id,
                        text: text
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                input.value = '';
                autoResizeTextarea();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
                await supabaseClient
                    .from('chats')
                    .update({ updated_at: new Date().toISOString() })
                    .eq('id', appState.currentChat.id);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã –∑–∞–Ω–æ–≤–æ
                loadChats();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
            }
        }
        
        async function toggleReaction(messageId, emoji) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ä–µ–∞–∫—Ü–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const { data: existingReaction, error: checkError } = await supabaseClient
                    .from('message_reactions')
                    .select('id')
                    .eq('message_id', messageId)
                    .eq('user_id', appState.currentUser.id)
                    .eq('emoji', emoji)
                    .single();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    throw checkError;
                }
                
                if (existingReaction) {
                    // –£–¥–∞–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏—é
                    const { error } = await supabaseClient
                        .from('message_reactions')
                        .delete()
                        .eq('id', existingReaction.id);
                    
                    if (error) throw error;
                } else {
                    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ä–µ–∞–∫—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    await supabaseClient
                        .from('message_reactions')
                        .delete()
                        .eq('message_id', messageId)
                        .eq('user_id', appState.currentUser.id);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Ä–µ–∞–∫—Ü–∏—é
                    const { error } = await supabaseClient
                        .from('message_reactions')
                        .insert({
                            message_id: messageId,
                            user_id: appState.currentUser.id,
                            emoji: emoji
                        });
                    
                    if (error) throw error;
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏:', error);
            }
        }
        
        function setupRealtimeSubscriptions() {
            if (!supabaseClient) return;
            
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            const messagesChannel = supabaseClient
                .channel('messages')
                .on('postgres_changes', 
                    { 
                        event: 'INSERT', 
                        schema: 'public', 
                        table: 'messages'
                    }, 
                    handleNewMessage
                )
                .subscribe();
            
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∞–∫—Ü–∏–∏
            const reactionsChannel = supabaseClient
                .channel('reactions')
                .on('postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'message_reactions'
                    },
                    handleReactionUpdate
                )
                .subscribe();
        }
        
        function subscribeToChat(chatId) {
            if (!supabaseClient) return;
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —ç—Ç–æ—Ç —á–∞—Ç
            supabaseClient.removeChannel('chat_' + chatId);
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —ç—Ç–æ—Ç —á–∞—Ç
            const chatChannel = supabaseClient
                .channel('chat_' + chatId)
                .on('postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'messages',
                        filter: `chat_id=eq.${chatId}`
                    },
                    handleNewMessage
                )
                .subscribe();
        }
        
        function handleNewMessage(payload) {
            const newMessage = payload.new;
            
            // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —á–∞—Ç–∞
            if (appState.currentChat && newMessage.chat_id === appState.currentChat.id) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                const existingMessage = document.querySelector(`[data-message-id="${newMessage.id}"]`);
                if (existingMessage) return;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                loadFullMessage(newMessage.id);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
            loadChats();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞
            if (document.hidden && appState.notificationsEnabled) {
                showPushNotification(newMessage);
            }
        }
        
        async function loadFullMessage(messageId) {
            try {
                const { data: message, error } = await supabaseClient
                    .from('messages')
                    .select(`
                        *,
                        message_reactions(*),
                        profiles!messages_sender_id_fkey(nickname, avatar_url)
                    `)
                    .eq('id', messageId)
                    .single();
                
                if (error) throw error;
                
                renderMessage(message, message.message_reactions || []);
                scrollToBottom();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            }
        }
        
        function handleReactionUpdate(payload) {
            const messageElement = document.querySelector(`[data-message-id="${payload.new?.message_id}"]`);
            if (messageElement) {
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–π
                if (appState.currentChat) {
                    loadMessages(appState.currentChat.id);
                }
            }
        }
        
        function scrollToBottom() {
            const messagesContainer = document.getElementById('messages-container');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        async function uploadAvatar() {
            const fileInput = document.getElementById('avatar-input');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
            const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showNotification('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5MB)', 'error');
                return;
            }
            
            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${appState.currentUser.id}/${Date.now()}.${fileExt}`;
                const filePath = `${fileName}`;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                const { error: uploadError } = await supabaseClient.storage
                    .from('avatars')
                    .upload(filePath, file, {
                        upsert: true
                    });
                
                if (uploadError) throw uploadError;
                
                // –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL
                const { data: { publicUrl } } = supabaseClient.storage
                    .from('avatars')
                    .getPublicUrl(filePath);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                const { error: updateError } = await supabaseClient
                    .from('profiles')
                    .update({ avatar_url: publicUrl })
                    .eq('id', appState.currentUser.id);
                
                if (updateError) throw updateError;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                appState.currentUser.avatar_url = publicUrl;
                updateProfileUI();
                
                showNotification('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞', 'error');
            }
        }
        
        async function updateNickname() {
            const input = document.getElementById('nickname-input');
            const nickname = input.value.trim();
            const errorElement = document.getElementById('nickname-error');
            
            errorElement.classList.add('hidden');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –Ω–∏–∫–Ω–µ–π–º–∞
            const nicknameRegex = /^@[a-zA-Z0-9_]{3,20}$/;
            if (!nicknameRegex.test(nickname)) {
                errorElement.querySelector('span').textContent = '–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å @ –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å 3-20 —Å–∏–º–≤–æ–ª–æ–≤ (–±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _)';
                errorElement.classList.remove('hidden');
                return;
            }
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–∏–∫–Ω–µ–π–º–∞
                const { data: existingUser, error: checkError } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('nickname', nickname)
                    .neq('id', appState.currentUser.id)
                    .single();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    throw checkError;
                }
                
                if (existingUser) {
                    errorElement.querySelector('span').textContent = '–≠—Ç–æ—Ç –Ω–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç';
                    errorElement.classList.remove('hidden');
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∏–∫–Ω–µ–π–º
                const { error: updateError } = await supabaseClient
                    .from('profiles')
                    .update({ nickname: nickname })
                    .eq('id', appState.currentUser.id);
                
                if (updateError) throw updateError;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                appState.currentUser.nickname = nickname;
                updateProfileUI();
                
                showNotification('–ù–∏–∫–Ω–µ–π–º –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∏–∫–Ω–µ–π–º–∞:', error);
                errorElement.querySelector('span').textContent = error.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∏–∫–Ω–µ–π–º–∞';
                errorElement.classList.remove('hidden');
            }
        }
        
        function checkNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                return;
            }
            
            appState.notificationPermission = Notification.permission;
            
            if (appState.notificationPermission === 'granted') {
                appState.notificationsEnabled = true;
            } else if (appState.notificationPermission === 'denied') {
                appState.notificationsEnabled = false;
            }
        }
        
        async function toggleNotifications() {
            const toggle = document.getElementById('notifications-toggle');
            
            if (!('Notification' in window)) {
                showNotification('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
                toggle.checked = false;
                return;
            }
            
            if (Notification.permission === 'denied') {
                showNotification('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—ã–ª–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ. –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                toggle.checked = false;
                return;
            }
            
            if (Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                appState.notificationPermission = permission;
                
                if (permission === 'granted') {
                    appState.notificationsEnabled = true;
                    toggle.checked = true;
                    showNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã', 'success');
                } else {
                    appState.notificationsEnabled = false;
                    toggle.checked = false;
                    showNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã', 'warning');
                }
            } else {
                appState.notificationsEnabled = toggle.checked;
            }
        }
        
        function showPushNotification(message) {
            if (!appState.notificationsEnabled || !message) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ
            const sender = appState.users[message.sender_id];
            const senderName = sender?.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            
            const notification = new Notification('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', {
                body: `${senderName}: ${message.text.substring(0, 100)}`,
                icon: sender?.avatar_url || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>',
                tag: 'message-' + message.id
            });
            
            notification.onclick = function() {
                window.focus();
                this.close();
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç
                if (appState.currentChat?.id !== message.chat_id) {
                    openChat(message.chat_id, message.sender_id);
                }
            };
        }
        
        function testNotification() {
            if (!appState.notificationsEnabled) {
                showNotification('–í–∫–ª—é—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö', 'warning');
                return;
            }
            
            if (Notification.permission === 'granted') {
                const notification = new Notification('–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ', {
                    body: '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç Supabase Messenger',
                    icon: appState.currentUser?.avatar_url || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>'
                });
                
                notification.onclick = function() {
                    window.focus();
                    this.close();
                };
            }
        }
        
        function markNotificationsAsRead() {
            // –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–º–µ—Ç–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
        }
        
        function initEmojiPicker() {
            const emojiPicker = document.getElementById('emoji-picker');
            const emojis = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò°', 'üôÇ', 'üòé', 'ü§î', 'üëè', 'üéâ', 'üî•'];
            
            emojiPicker.querySelector('div').innerHTML = emojis.map(emoji => `
                <button class="btn btn-text" style="font-size: 24px; padding: 5px;" onclick="insertEmoji('${emoji}')">${emoji}</button>
            `).join('');
        }
        
        function toggleEmojiPicker() {
            const emojiPicker = document.getElementById('emoji-picker');
            emojiPicker.classList.toggle('hidden');
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —ç–º–æ–¥–∑–∏ –ø–∏–∫–µ—Ä
            if (!emojiPicker.classList.contains('hidden')) {
                const emojiBtn = document.getElementById('emoji-btn');
                const rect = emojiBtn.getBoundingClientRect();
                
                emojiPicker.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
                emojiPicker.style.right = (window.innerWidth - rect.right) + 'px';
            }
        }
        
        function insertEmoji(emoji) {
            const input = document.getElementById('message-input');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            
            input.value = input.value.substring(0, start) + emoji + input.value.substring(end);
            input.focus();
            input.setSelectionRange(start + emoji.length, start + emoji.length);
            
            autoResizeTextarea();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∏–∫–µ—Ä
            document.getElementById('emoji-picker').classList.add('hidden');
        }
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications-container');
            const id = 'notification-' + Date.now();
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            const notification = document.createElement('div');
            notification.id = id;
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${icons[type]}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${type === 'success' ? '–£—Å–ø–µ—à–Ω–æ' : type === 'error' ? '–û—à–∏–±–∫–∞' : type === 'warning' ? '–í–Ω–∏–º–∞–Ω–∏–µ' : '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="closeNotification('${id}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => closeNotification(id), 5000);
        }
        
        function closeNotification(id) {
            const notification = document.getElementById(id);
            if (notification) {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function formatTime(timestamp, includeSeconds = false) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) {
                return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            } else if (diffMins < 60) {
                return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            } else if (diffHours < 24) {
                return `${diffHours} —á –Ω–∞–∑–∞–¥`;
            } else if (diffDays < 7) {
                return `${diffDays} –¥–Ω –Ω–∞–∑–∞–¥`;
            } else {
                return date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'short',
                    year: diffDays > 365 ? 'numeric' : undefined
                });
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ HTML
        window.insertEmoji = insertEmoji;
        window.toggleReaction = toggleReaction;
        window.closeNotification = closeNotification;
    </script>
</body>
</html>
