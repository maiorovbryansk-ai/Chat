<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OneFile Messenger ‚Äî Supabase</title>
  
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#94a3b8;
      --accent:#6ee7b7;
      --glass: rgba(255,255,255,0.03);
      --danger:#ff6b6b;
      --glass-2: rgba(255,255,255,0.02);
      --radius:12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body,#app{height:100%; margin:0; background:linear-gradient(180deg,#071025 0%, var(--bg) 100%); color:#e6eef8;}
    a{color:inherit}
    
    .app {
      display:flex;
      gap:18px;
      padding:18px;
      height:100vh;
      align-items:stretch;
    }
    .sidebar {
      width:320px;
      min-width:240px;
      background:linear-gradient(180deg,var(--card), rgba(11,18,32,0.9));
      border-radius:var(--radius);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
    }
    .main {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius:12px;
      padding:12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
    }
    
    .topbar {
      height:60px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .search {
      display:flex;
      gap:8px;
      align-items:center;
      background:var(--glass);
      padding:8px;
      border-radius:10px;
    }
    .search input{
      background:transparent;
      border:0;
      outline:none;
      color:var(--muted);
      width:100%;
    }
    
    .chats {
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      padding-right:6px;
    }
    .chat-item {
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px;
      border-radius:10px;
      cursor:pointer;
      transition:background .15s;
    }
    .chat-item:hover { background:var(--glass-2); }
    .chat-item.active { background:linear-gradient(90deg, rgba(110,231,183,0.08), transparent); box-shadow: 0 6px 14px rgba(12,20,28,0.4); }
    
    .avatar {
      width:44px;height:44px;border-radius:10px;flex-shrink:0;background:linear-gradient(90deg,#14374a,#1f2b3a);display:grid;place-items:center;font-weight:700;color:var(--accent)
    }
    .meta {flex:1; min-width:0}
    .meta .title { font-weight:600; font-size:14px; color:#e6f2ff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .meta .subtitle { font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .badge { background:var(--accent); color:#022; min-width:22px; height:22px; display:inline-grid; place-items:center; padding:0 6px; border-radius:999px; font-weight:700; font-size:12px; }
    
    .chat-area { display:flex; flex-direction:column; height: calc(100vh - 80px); min-height:0; }
    .messages {
      flex:1;
      overflow:auto;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .message {
      max-width:70%;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      padding:10px 12px;
      border-radius:12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.35);
      word-break:break-word;
    }
    .message.me { margin-left:auto; background:linear-gradient(180deg, rgba(110,231,183,0.08), rgba(110,231,183,0.02)); border:1px solid rgba(110,231,183,0.06); }
    .message .meta { font-size:12px; color:var(--muted); margin-bottom:6px; display:flex; gap:8px; align-items:center; }
    .message .content { font-size:14px; color:#e8f6f0; }
    .message .row { display:flex; gap:8px; align-items:center; margin-top:8px }
    .message .small { font-size:12px; color:var(--muted) }
    
    .compose {
      display:flex;
      gap:8px;
      padding:12px;
      align-items:center;
    }
    .compose textarea {
      flex:1; resize:none; min-height:48px; max-height:120px; padding:10px; border-radius:10px; border:0; outline:none; background:rgba(255,255,255,0.02); color:#e8f6f0;
    }
    .btn {
      background:linear-gradient(90deg,var(--accent), #34d399);
      color:#062018; padding:10px 12px; border-radius:10px; cursor:pointer; border:0; font-weight:700;
    }
    .btn.ghost { background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); }
    
    .modal {
      position:fixed; left:0; top:0; right:0; bottom:0; display:none; align-items:center; justify-content:center;
      background:rgba(2,6,23,0.6); z-index:50;
    }
    .modal.open{ display:flex; }
    .modal .card { width:720px; max-width:95%; background:linear-gradient(180deg, #071226, #05101b); border-radius:14px; padding:18px; box-shadow: 0 12px 40px rgba(0,0,0,0.7); }
    .row { display:flex; gap:8px; align-items:center; }
    .field { display:flex; flex-direction:column; gap:6px; }
    input, select { padding:10px; border-radius:10px; border:0; background:rgba(255,255,255,0.02); color:#e6eef8; min-width:0; outline:none; }
    label { font-size:13px; color:var(--muted) }
    
    .toast { position:fixed; right:18px; bottom:18px; background:linear-gradient(180deg,#0b1220, #071226); padding:12px 16px; border-radius:10px; box-shadow:0 8px 24px rgba(2,6,23,0.6); color:#dff7ea; display:none; z-index:60; }
    .toast.show { display:block; }
    
    @media (max-width:880px){
      .sidebar { display:none; }
      .app { padding:8px; }
      .chat-area { height:calc(100vh - 18px); }
    }
  </style>
</head>
<body>
  <div id="app" class="app">
    <div class="sidebar panel" id="sidebar">
      <div class="topbar">
        <div style="display:flex; gap:8px; align-items:center">
          <div style="font-weight:800; font-size:18px; color:var(--accent)">OneFile</div>
          <div style="color:var(--muted); font-size:13px">Messenger</div>
        </div>
        <div id="auth-controls">
          <!-- –ö–Ω–æ–ø–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>
      </div>

      <div class="search">
        <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ @nickname –∏–ª–∏ —á–∞—Ç..." />
        <button id="btnSearch" class="btn ghost">–ù–∞–π—Ç–∏</button>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center">
        <div style="font-weight:700; color:var(--muted)">–ß–∞—Ç—ã</div>
        <div style="display:flex; gap:8px">
          <button id="btnNewChat" class="btn ghost" title="–°–æ–∑–¥–∞—Ç—å —á–∞—Ç">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
      </div>

      <div class="chats" id="chatsList" aria-live="polite"></div>

      <div style="margin-top:auto; display:flex; align-items:center; gap:10px">
        <div id="profilePreview" style="display:flex; gap:10px; align-items:center; width:100%">
          <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>
      </div>
    </div>

    <div class="main">
      <div class="panel topbar" id="chatHeader">
        <div style="display:flex; gap:12px; align-items:center;">
          <div id="activeChatAvatar" class="avatar">?</div>
          <div>
            <div id="activeChatTitle" style="font-weight:700">–í—ã–±–µ—Ä–∏ —á–∞—Ç</div>
            <div id="activeChatSubtitle" style="font-size:12px; color:var(--muted)">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ</div>
          </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center">
          <button id="btnAddMember" class="btn ghost">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button id="btnLeaveChat" class="btn ghost">–í—ã–π—Ç–∏</button>
        </div>
      </div>

      <div class="panel chat-area">
        <div id="messages" class="messages" tabindex="0"></div>

        <div class="compose">
          <button id="emojiBtn" class="btn ghost">üòä</button>
          <textarea id="messageInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="2"></textarea>
          <button id="sendBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="card" id="modalCard"></div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
    const SUPABASE_URL = 'https://vhcgcaerztzdqkmplbcg.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_i1463Kqkkb8cQbX8t1Vb7Q_iBE4MTEd';
    const AVATARS_BUCKET = 'avatars';

    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    import { EmojiButton } from 'https://esm.sh/@joeattardi/emoji-button@4.6.2';

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Å–µ—Å—Å–∏–∏
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: false,
        storage: window.localStorage,
        flowType: 'pkce'
      }
    });

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    let currentUser = null;
    let currentProfile = null;
    let activeChat = null;
    let chatsCache = {};
    let membersCache = {};
    let messagesCache = {};
    let reactionsCache = {};
    let sessionRefreshInterval = null;

    // === –£–¢–ò–õ–ò–¢–´ ===
    const $ = (sel) => document.querySelector(sel);
    const $c = (tag, attrs = {}) => {
      const el = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => {
        if(k === 'class') el.className = v;
        else if(k === 'text') el.textContent = v;
        else el.setAttribute(k, v);
      });
      return el;
    };
    
    const toast = (text, time=3000) => {
      const t = $('#toast');
      t.textContent = text;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), time);
    };
    
    const openModal = (contentHtml) => {
      $('#modalCard').innerHTML = contentHtml;
      $('#modal').classList.add('open');
    };
    
    const closeModal = () => $('#modal').classList.remove('open');
    
    const escapeHtml = (s) => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ï–°–°–ò–ï–ô ===
    function setupSessionRefresh() {
      if (sessionRefreshInterval) clearInterval(sessionRefreshInterval);
      
      sessionRefreshInterval = setInterval(async () => {
        if (currentUser) {
          try {
            console.log('üîÑ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏...');
            const { data: { session }, error } = await supabase.auth.refreshSession();
            if (error) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
              if (error.message.includes('invalid') || error.message.includes('expired')) {
                toast('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                await handleSignOut();
              }
            }
          } catch (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', err);
          }
        }
      }, 25 * 60 * 1000);
    }

    async function restoreSession() {
      try {
        console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏...');
        
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏:', sessionError);
          return false;
        }
        
        if (session) {
          console.log('‚úÖ –°–µ—Å—Å–∏—è –Ω–∞–π–¥–µ–Ω–∞, –∏—Å—Ç–µ–∫–∞–µ—Ç:', new Date(session.expires_at * 1000));
          
          const expiresAt = session.expires_at;
          const now = Math.floor(Date.now() / 1000);
          
          if (expiresAt - now < 600) {
            console.log('üîÑ –¢–æ–∫–µ–Ω —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á–µ—Ç, –æ–±–Ω–æ–≤–ª—è—é...');
            const { data: refreshed, error: refreshError } = await supabase.auth.refreshSession();
            if (refreshError) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', refreshError);
              return false;
            }
            console.log('‚úÖ –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω');
          }
          
          await ensureProfile(session.user);
          await loadInitialData();
          setupSessionRefresh();
          return true;
        }
      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', err);
      }
      
      return false;
    }

    async function handleSignOut() {
      console.log('üö™ –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã...');
      await supabase.auth.signOut();
      currentUser = null;
      currentProfile = null;
      if (sessionRefreshInterval) {
        clearInterval(sessionRefreshInterval);
        sessionRefreshInterval = null;
      }
      renderAuthControls();
      clearUI();
      toast('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
    }

    // === –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –ü–†–û–§–ò–õ–¨ ===
    async function ensureProfile(authUser) {
      const uid = authUser.id;
      const email = authUser.email || 'user';
      
      console.log('üîç ensureProfile –¥–ª—è:', uid);
      
      try {
        // 1. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –±–∞–∑—ã
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', uid)
          .single();
        
        // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞–π–¥–µ–Ω
        if (profile) {
          console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –Ω–∞–π–¥–µ–Ω:', profile.nickname);
          currentProfile = profile;
          currentUser = uid;
          
          // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏–º UI
          setTimeout(() => {
            renderAuthControls();
            renderProfilePreview();
          }, 0);
          return;
        }
        
        // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
        if (error && (error.code === 'PGRST116' || error.message.includes('found'))) {
          console.log('üìù –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π...');
          
          // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –Ω–∏–∫
          let tempNick;
          if (email.includes('@')) {
            const username = email.split('@')[0].replace(/[^a-z0-9_]/gi, '');
            tempNick = `@${username.slice(0, 15).toLowerCase()}`;
          } else {
            tempNick = `@user_${uid.slice(0, 8)}`;
          }
          
          // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ –±–∞–∑–µ
          const { data: newProfile, error: insertError } = await supabase
            .from('profiles')
            .insert({ 
              id: uid, 
              nickname: tempNick,
              created_at: new Date().toISOString()
            })
            .select()
            .single();
          
          if (insertError) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', insertError);
            
            // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–ª)
            if (insertError.code === '23505') {
              console.log('üîÑ –ü—Ä–æ—Ñ–∏–ª—å —É–∂–µ —Å–æ–∑–¥–∞–Ω, –ø–æ–ª—É—á–∞–µ–º...');
              const { data: existing } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', uid)
                .single();
              currentProfile = existing;
            } else {
              // –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –∫–∞–∫ fallback
              currentProfile = { 
                id: uid, 
                nickname: tempNick,
                created_at: new Date().toISOString()
              };
              toast('‚ö†Ô∏è –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ');
            }
          } else {
            currentProfile = newProfile;
            console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω –≤ –±–∞–∑–µ:', newProfile.nickname);
          }
          
        } else if (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
          // –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –∫–∞–∫ fallback
          currentProfile = { 
            id: uid, 
            nickname: `@user_${uid.slice(0, 8)}`,
            created_at: new Date().toISOString()
          };
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        currentUser = uid;
        
        // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏–º UI
        setTimeout(() => {
          renderAuthControls();
          renderProfilePreview();
        }, 0);
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏–∫–Ω–µ–π–º–∞ –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–π, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
        if (!currentProfile?.nickname || currentProfile.nickname.startsWith('@user_')) {
          setTimeout(() => {
            if (currentUser === uid) {
              openProfileEditor({ requireNickname: true });
            }
          }, 1500);
        }
        
      } catch (err) {
        console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ ensureProfile:', err);
        // –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã UI
        currentUser = uid;
        currentProfile = { 
          id: uid, 
          nickname: `@user_${uid.slice(0, 8)}`
        };
        // –†–µ–Ω–¥–µ—Ä–∏–º UI –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É
        setTimeout(() => {
          renderAuthControls();
          renderProfilePreview();
        }, 0);
      }
    }

    function renderAuthControls() {
      console.log('üé® renderAuthControls –≤—ã–∑–≤–∞–Ω, currentUser:', currentUser, 'currentProfile:', currentProfile?.nickname);
      
      const el = $('#auth-controls');
      if (!el) {
        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç auth-controls –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
      }
      
      el.innerHTML = '';
      
      if (!currentUser) {
        console.log('üë• –†–µ–Ω–¥–µ—Ä–∏–º –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
        
        const btnIn = $c('button', { 
          class: 'btn', 
          text: '–í–æ–π—Ç–∏',
          style: 'min-width: 80px;'
        });
        btnIn.onclick = () => openSignIn();
        
        const btnUp = $c('button', { 
          class: 'btn ghost', 
          text: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
          style: 'min-width: 100px;'
        });
        btnUp.onclick = () => openSignUp();
        
        el.appendChild(btnIn);
        el.appendChild(btnUp);
        
      } else {
        console.log('üë§ –†–µ–Ω–¥–µ—Ä–∏–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentProfile?.nickname || '–±–µ–∑ –Ω–∏–∫–∞');
        
        const nickname = currentProfile?.nickname || '–ü—Ä–æ—Ñ–∏–ª—å';
        const displayName = nickname.length > 10 ? nickname.slice(0, 10) + '...' : nickname;
        
        const btnProfile = $c('button', { 
          class: 'btn ghost', 
          text: displayName,
          style: 'min-width: 80px; max-width: 120px; overflow: hidden; text-overflow: ellipsis;',
          title: nickname
        });
        btnProfile.onclick = () => openProfileEditor();
        
        const btnOut = $c('button', { 
          class: 'btn', 
          text: '–í—ã–π—Ç–∏',
          style: 'min-width: 80px;'
        });
        btnOut.onclick = async () => {
          await handleSignOut();
        };
        
        el.appendChild(btnProfile);
        el.appendChild(btnOut);
      }
    }

    function renderProfilePreview() {
      console.log('üë§ renderProfilePreview –≤—ã–∑–≤–∞–Ω, –ø—Ä–æ—Ñ–∏–ª—å:', currentProfile);
      
      const node = $('#profilePreview');
      if (!node) {
        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç profilePreview –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
      }
      
      node.innerHTML = '';
      
      if (!currentProfile) {
        console.log('‚ÑπÔ∏è currentProfile –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ—Ñ–∏–ª—è
        const av = $c('div', { class: 'avatar' });
        av.textContent = '?';
        av.style.background = 'linear-gradient(90deg,#14374a,#1f2b3a)';
        
        const info = $c('div');
        info.innerHTML = `
          <div style="font-weight:700; font-size:14px">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π</div>
          <div style="font-size:11px; color:var(--muted)">...</div>
        `;
        
        node.appendChild(av);
        node.appendChild(info);
        return;
      }
      
      const av = $c('div', { class: 'avatar' });
      if (currentProfile.avatar_url) {
        av.style.background = `url(${currentProfile.avatar_url}) center/cover`;
        av.textContent = '';
      } else {
        const initials = currentProfile.nickname 
          ? currentProfile.nickname.slice(1, 3).toUpperCase() || 'U'
          : 'U';
        av.textContent = initials;
        av.style.background = 'linear-gradient(90deg,#14374a,#1f2b3a)';
      }
      
      const info = $c('div');
      const nickname = currentProfile.nickname || '–ë–µ–∑ –Ω–∏–∫–∞';
      const displayNickname = nickname.length > 12 ? nickname.slice(0, 12) + '...' : nickname;
      
      info.innerHTML = `
        <div style="font-weight:700; font-size:14px" title="${nickname}">${displayNickname}</div>
        <div style="font-size:11px; color:var(--muted)">${currentUser?.slice(0, 8) || '???'}</div>
      `;
      
      node.appendChild(av);
      node.appendChild(info);
      
      console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω:', currentProfile.nickname);
    }

    // === –§–û–†–ú–´ –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ===
    function openSignIn() {
      openModal(`
        <h3>–í—Ö–æ–¥</h3>
        <div class="row" style="margin-top:8px">
          <div style="flex:1" class="field">
            <label>Email</label>
            <input id="si_email" placeholder="email@example.com" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:1" class="field">
            <label>–ü–∞—Ä–æ–ª—å</label>
            <input id="si_password" type="password" placeholder="–ø–∞—Ä–æ–ª—å" />
          </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
          <button id="si_btn" class="btn">–í–æ–π—Ç–∏</button>
          <button class="btn ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `);
      $('#si_btn').onclick = async () => {
        const email = $('#si_email').value.trim();
        const password = $('#si_password').value;
        if(!email || !password) return toast('–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è');
        
        const { error } = await supabase.auth.signInWithPassword({ 
          email, 
          password 
        });
        
        if(error) {
          toast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
        } else {
          closeModal();
          toast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
        }
      };
    }

    function openSignUp() {
      openModal(`
        <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
        <div class="row" style="margin-top:8px">
          <div style="flex:1" class="field">
            <label>Email</label>
            <input id="su_email" placeholder="email@example.com" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:1" class="field">
            <label>–ü–∞—Ä–æ–ª—å</label>
            <input id="su_password" type="password" placeholder="–ø–∞—Ä–æ–ª—å (min 6)" />
          </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
          <button id="su_btn" class="btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          <button class="btn ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `);
      $('#su_btn').onclick = async () => {
        const email = $('#su_email').value.trim();
        const password = $('#su_password').value;
        if(!email || !password) return toast('–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è');
        if(password.length < 6) return toast('–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
        
        const { data, error } = await supabase.auth.signUp({ 
          email, 
          password 
        });
        
        if(error) {
          toast('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
        } else {
          toast('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.');
          closeModal();
        }
      };
    }

    function openProfileEditor(opts = {}) {
      const requireNickname = !!opts.requireNickname;
      const currentNickname = currentProfile?.nickname || '';
      
      openModal(`
        <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
        <div style="display:flex; gap:12px; margin-top:8px">
          <div style="width:120px">
            <div id="pe_avatar" class="avatar" style="width:120px;height:120px;border-radius:14px">
              ${currentProfile?.avatar_url ? '' : (currentProfile?.nickname ? currentProfile.nickname.slice(1,3).toUpperCase() : 'U')}
            </div>
          </div>
          <div style="flex:1">
            <div class="field">
              <label>–ù–∏–∫–Ω–µ–π–º (—Ñ–æ—Ä–º–∞—Ç: @nickname)</label>
              <input id="pe_nickname" placeholder="@nick" value="${currentNickname}" />
              <div style="font-size:12px;color:var(--muted)">–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è.</div>
            </div>
            <div style="display:flex; gap:8px; margin-top:8px">
              <input id="pe_avatar_file" type="file" accept="image/*" />
              <button id="pe_upload" class="btn ghost">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
            <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end">
              <button id="pe_save" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn ghost" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
        </div>
      `);
      
      const av = $('#pe_avatar');
      if(currentProfile?.avatar_url) {
        av.style.background = `url(${currentProfile.avatar_url}) center/cover`;
        av.textContent = '';
      } else {
        av.style.background = 'linear-gradient(90deg,#14374a,#1f2b3a)';
      }
      
      $('#pe_upload').onclick = async () => {
        const file = $('#pe_avatar_file').files?.[0];
        if(!file) return toast('–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª');
        
        const ext = file.name.split('.').pop();
        const fileName = `avatars/${currentUser}/${Date.now()}.${ext}`;
        
        const up = await supabase.storage
          .from(AVATARS_BUCKET)
          .upload(fileName, file, { 
            cacheControl: '3600', 
            upsert: true 
          });
          
        if(up.error) return toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + up.error.message);
        
        const { data: publicUrl } = supabase.storage
          .from(AVATARS_BUCKET)
          .getPublicUrl(fileName);
          
        const { error } = await supabase
          .from('profiles')
          .update({ avatar_url: publicUrl.publicUrl })
          .eq('id', currentUser);
          
        if(error) return toast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
        
        currentProfile.avatar_url = publicUrl.publicUrl;
        av.style.background = `url(${publicUrl.publicUrl}) center/cover`;
        av.textContent = '';
        renderProfilePreview();
        toast('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω');
      };
      
      $('#pe_save').onclick = async () => {
        let nick = $('#pe_nickname').value.trim();
        
        if(!nick && requireNickname) {
          return toast('–ù—É–∂–Ω–æ –∑–∞–¥–∞—Ç—å @nickname');
        }
        
        if(nick && !nick.startsWith('@')) {
          nick = '@' + nick;
        }
        
        if(nick && !/^@[A-Za-z0-9_]{3,20}$/.test(nick)) {
          return toast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–∏–∫–Ω–µ–π–º–∞');
        }
        
        if(nick){
          const { data: exist } = await supabase
            .from('profiles')
            .select('id')
            .eq('nickname', nick)
            .limit(1);
            
          if(exist && exist.length && exist[0].id !== currentUser) {
            return toast('–ù–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç');
          }
        }
        
        const { error } = await supabase
          .from('profiles')
          .update({ nickname: nick || null })
          .eq('id', currentUser);
          
        if(error) {
          toast('–û—à–∏–±–∫–∞: ' + error.message);
        } else {
          currentProfile.nickname = nick || null;
          renderProfilePreview();
          renderAuthControls();
          closeModal();
          toast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        }
      };
    }

    // === –§–£–ù–ö–¶–ò–ò UI HANDLERS ===
    function setupUIHandlers() {
      console.log('üéõÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ UI...');
      
      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
      $('#sendBtn').onclick = sendMessage;
      $('#messageInput').addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && !e.shiftKey) { 
          e.preventDefault(); 
          sendMessage(); 
        }
      });
      
      // –ö–Ω–æ–ø–∫–∏ —á–∞—Ç–∞
      $('#btnNewChat').onclick = openCreateChat;
      $('#btnAddMember').onclick = openAddMemberModal;
      $('#btnLeaveChat').onclick = leaveChatConfirm;
      $('#btnSearch').onclick = handleSearch;
      
      // –ü–æ–∏—Å–∫
      $('#searchInput').addEventListener('keydown', (e) => { 
        if(e.key === 'Enter') handleSearch(); 
      });

      // Emoji picker
      try {
        const picker = new EmojiButton({ position: 'top-end', zIndex: 9999 });
        $('#emojiBtn').addEventListener('click', () => picker.togglePicker($('#emojiBtn')));
        picker.on('emoji', emoji => {
          const area = $('#messageInput');
          area.value = area.value + emoji;
          area.focus();
        });
      } catch (err) {
        console.warn('‚ö†Ô∏è Emoji picker –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è:', err);
      }

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      $('#modal').addEventListener('click', (e) => {
        if(e.target === $('#modal')) closeModal();
      });
      
      // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
      window.closeModal = closeModal;
    }

    // === –§–£–ù–ö–¶–ò–ò –ß–ê–¢–ê ===
    async function loadInitialData() {
      try {
        await loadChatsList();
      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
      }
    }

    async function loadChatsList() {
      if(!currentUser) {
        console.log('üë§ –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —á–∞—Ç–æ–≤');
        return;
      }
      
      console.log('üìã –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤...');
      
      try {
        // –ü–æ–ª—É—á–∞–µ–º ID —á–∞—Ç–æ–≤, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—á–∞—Å—Ç–Ω–∏–∫
        const { data: memberChats, error: memberError } = await supabase
          .from('chat_members')
          .select('chat_id')
          .eq('user_id', currentUser);
          
        if (memberError) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–ª–µ–Ω—Å—Ç–≤–∞ –≤ —á–∞—Ç–∞—Ö:', memberError);
          return;
        }
        
        const chatIds = memberChats?.map(x => x.chat_id) || [];
        
        console.log(`üìä –ù–∞–π–¥–µ–Ω–æ ${chatIds.length} —á–∞—Ç–æ–≤`);
        
        if (chatIds.length === 0) {
          chatsCache = {};
          renderChatsList();
          return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —á–∞—Ç—ã
        const { data: myChats, error: chatsError } = await supabase
          .from('chats')
          .select('id,name,avatar_url,is_group,creator,created_at')
          .in('id', chatIds);

        if(chatsError) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', chatsError);
          return;
        }
        
        console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${myChats?.length || 0} —á–∞—Ç–æ–≤`);
        
        chatsCache = {};
        for(const c of (myChats || [])){
          chatsCache[c.id] = c;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞
        await Promise.all(Object.keys(chatsCache).map(cid => loadChatMeta(cid)));
        renderChatsList();
      } catch (err) {
        console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ loadChatsList:', err);
      }
    }

    async function loadChatMeta(chatId) {
      try {
        const [{ data: members }, { data: msgs }] = await Promise.all([
          supabase
            .from('chat_members')
            .select('user_id,role,joined_at,last_read_at,profiles(id,nickname,avatar_url)')
            .eq('chat_id', chatId),
          supabase
            .from('messages')
            .select('id,chat_id,sender_id,content,created_at,edited,deleted')
            .eq('chat_id', chatId)
            .order('created_at', { ascending:false })
            .limit(1)
        ]);
        
        membersCache[chatId] = members || [];
        messagesCache[chatId] = msgs ? msgs.slice().reverse() : [];
      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —á–∞—Ç–∞:', err);
      }
    }

    function renderChatsList() {
      const list = $('#chatsList');
      if (!list) {
        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç chatsList –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
      }
      
      list.innerHTML = '';
      const chatEntries = Object.values(chatsCache).sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
      
      if (chatEntries.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted);">–ù–µ—Ç —á–∞—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</div>';
        return;
      }
      
      console.log(`üé® –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ ${chatEntries.length} —á–∞—Ç–æ–≤`);
      
      for(const c of chatEntries){
        const item = $c('div', { class:'chat-item', id:'chat-'+c.id });
        item.onclick = async () => await openChat(c.id);
        
        const av = $c('div', { class:'avatar' });
        if(c.avatar_url) {
          av.style.background = `url(${c.avatar_url}) center/cover`;
          av.textContent = '';
        } else {
          av.textContent = c.name ? c.name.charAt(0).toUpperCase() : 'C';
        }
        
        const meta = $c('div', { class:'meta' });
        const title = $c('div', { 
          class:'title', 
          text: c.is_group ? (c.name || '–ì—Ä—É–ø–ø–∞') : '–õ–∏—á–Ω—ã–π —á–∞—Ç' 
        });
        
        const subtitle = $c('div', { class:'subtitle', text: '–ó–∞–≥—Ä—É–∑–∫–∞...' });
        const msgs = messagesCache[c.id] || [];
        
        if(msgs.length){
          const m = msgs[msgs.length-1];
          const content = m.deleted ? '–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ' : (m.content || '').slice(0,40);
          subtitle.textContent = content + (m.edited ? ' (–æ—Ç—Ä–µ–¥.)' : '');
        } else {
          subtitle.textContent = '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
        }
        
        meta.appendChild(title);
        meta.appendChild(subtitle);
        
        const member = (membersCache[c.id] || []).find(m => m.user_id === currentUser);
        const unread = computeUnreadCount(c.id, member);
        const right = $c('div');
        
        if(unread > 0){
          const b = $c('div', { class:'badge', text: String(unread) });
          right.appendChild(b);
        }
        
        item.appendChild(av);
        item.appendChild(meta);
        item.appendChild(right);
        list.appendChild(item);
      }
    }

    function computeUnreadCount(chatId, member) {
      if(!member) return 0;
      const lastRead = member.last_read_at ? new Date(member.last_read_at) : null;
      const msgs = messagesCache[chatId] || [];
      if(!msgs.length) return 0;
      let cnt = 0;
      for(const m of msgs){
        if(!lastRead || new Date(m.created_at) > lastRead) cnt++;
      }
      return cnt;
    }

    async function openChat(chatId) {
      if(!chatId) return;
      
      console.log('üí¨ –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞:', chatId);
      
      try {
        activeChat = chatsCache[chatId];
        
        if(!activeChat){
          const { data } = await supabase.from('chats').select('*').eq('id', chatId).single();
          if (data) {
            chatsCache[chatId] = data;
            activeChat = data;
          } else {
            toast('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
          }
        }
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
        document.querySelectorAll('.chat-item').forEach(n => n.classList.remove('active'));
        const node = document.getElementById('chat-'+chatId);
        if(node) node.classList.add('active');
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        $('#activeChatAvatar').style.background = activeChat.avatar_url ? `url(${activeChat.avatar_url}) center/cover` : '';
        $('#activeChatAvatar').textContent = activeChat.avatar_url ? '' : (activeChat.name || 'C').charAt(0).toUpperCase();
        $('#activeChatTitle').textContent = activeChat.is_group ? (activeChat.name || '–ì—Ä—É–ø–ø–∞') : renderPrivateTitle(chatId);
        $('#activeChatSubtitle').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...';

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        const [{ data: msgs }, { data: members }] = await Promise.all([
          supabase
            .from('messages')
            .select('id,chat_id,sender_id,content,created_at,updated_at,edited,deleted')
            .eq('chat_id', chatId)
            .order('created_at', { ascending:true })
            .limit(100),
          supabase
            .from('chat_members')
            .select('user_id,role,last_read_at,profiles(id,nickname,avatar_url)')
            .eq('chat_id', chatId)
        ]);
        
        messagesCache[chatId] = msgs || [];
        membersCache[chatId] = members || [];

        renderMessages(chatId);
        
        // –û—Ç–º–µ—Ç–∫–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
        await supabase
          .from('chat_members')
          .update({ last_read_at: new Date().toISOString() })
          .eq('chat_id', chatId)
          .eq('user_id', currentUser);
          
        console.log('‚úÖ –ß–∞—Ç –æ—Ç–∫—Ä—ã—Ç:', activeChat.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
        
      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞:', err);
        toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞');
      }
    }

    function renderPrivateTitle(chatId) {
      const members = membersCache[chatId] || [];
      const other = members.find(m => m.user_id !== currentUser);
      if(other && other.profiles) return other.profiles.nickname || other.profiles.id.slice(0,8);
      return '–õ–∏—á–Ω—ã–π —á–∞—Ç';
    }

    function renderMessages(chatId) {
      const root = $('#messages');
      if (!root) return;
      
      root.innerHTML = '';
      const msgs = messagesCache[chatId] || [];
      
      if (msgs.length === 0) {
        root.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--muted);">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</div>';
        $('#activeChatSubtitle').textContent = '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
        return;
      }
      
      console.log(`üí≠ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ ${msgs.length} —Å–æ–æ–±—â–µ–Ω–∏–π`);
      
      for(const m of msgs){
        const isMe = m.sender_id === currentUser;
        const msg = $c('div', { class: 'message ' + (isMe ? 'me' : '') });
        
        const meta = $c('div', { class:'meta' });
        const senderProfile = getProfileForId(m.sender_id);
        const senderName = senderProfile?.nickname || (m.sender_id?.slice(0,8) || 'Unknown');
        
        const time = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        meta.innerHTML = `<div style="font-weight:700">${senderName}</div><div style="font-size:12px;color:var(--muted)">${time}</div>`;
        
        if(m.edited) meta.innerHTML += `<div style="font-size:12px;color:var(--muted);margin-left:8px">(—Ä–µ–¥.)</div>`;
        
        const content = $c('div', { class:'content', text: m.deleted ? '–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ' : m.content });
        msg.appendChild(meta);
        msg.appendChild(content);
        
        // –î–µ–π—Å—Ç–≤–∏—è —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        if(!m.deleted){
          const row = $c('div', { class:'row' });
          
          // –†–µ–∞–∫—Ü–∏–∏
          const reacts = reactionsCache[m.id] || [];
          if(reacts.length){
            const small = $c('div', { class:'small', text: reacts.map(r => r.emoji).join(' ') });
            row.appendChild(small);
          }
          
          // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
          if(isMe){
            const editBtn = $c('button', { class:'btn ghost', text:'–†–µ–¥.', style: 'font-size: 11px; padding: 4px 8px;' });
            editBtn.onclick = () => openEditMessage(m);
            
            const delBtn = $c('button', { class:'btn ghost', text:'–£–¥–∞–ª.', style: 'font-size: 11px; padding: 4px 8px;' });
            delBtn.onclick = () => deleteMessageConfirm(m.id);
            
            row.appendChild(editBtn);
            row.appendChild(delBtn);
          }
          
          // –ö–Ω–æ–ø–∫–∞ —Ä–µ–∞–∫—Ü–∏–∏
          const reactBtn = $c('button', { class:'btn ghost', text:'‚ù§', style: 'font-size: 11px; padding: 4px 8px;' });
          reactBtn.onclick = () => openEmojiForMessage(m.id);
          row.appendChild(reactBtn);
          
          msg.appendChild(row);
        }
        
        root.appendChild(msg);
      }
      
      // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
      setTimeout(() => {
        root.scrollTop = root.scrollHeight;
        $('#activeChatSubtitle').textContent = `${msgs.length} —Å–æ–æ–±—â–µ–Ω–∏–π`;
      }, 100);
    }

    function getProfileForId(uid) {
      // –ò—â–µ–º –≤ –∫—ç—à–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
      for(const mid in membersCache){
        const m = (membersCache[mid] || []).find(x => x.user_id === uid);
        if(m && m.profiles) return m.profiles;
      }
      
      // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      if(currentProfile?.id === uid) return currentProfile;
      
      return null;
    }

    async function sendMessage() {
      if(!activeChat) {
        toast('–í—ã–±–µ—Ä–∏ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
      }
      
      const content = $('#messageInput').value.trim();
      if(!content) {
        toast('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
        return;
      }
      
      console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç:', activeChat.id);
      
      try {
        const payload = {
          chat_id: activeChat.id,
          sender_id: currentUser,
          content,
          created_at: new Date().toISOString()
        };
        
        const { data, error } = await supabase.from('messages').insert(payload).select().single();
        
        if(error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
          toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
        } else {
          $('#messageInput').value = '';
          toast('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
        }
      } catch (err) {
        console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', err);
        toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
      }
    }

    async function openEditMessage(message) {
      openModal(`
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
        <div class="field" style="margin-top:8px">
          <textarea id="edit_content" rows="4" style="width: 100%;">${escapeHtml(message.content)}</textarea>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px">
          <button id="edit_save" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `);
      
      $('#edit_save').onclick = async () => {
        const newContent = $('#edit_content').value.trim();
        if(!newContent) {
          toast('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
          return;
        }
        
        const { error } = await supabase
          .from('messages')
          .update({ 
            content: newContent, 
            edited: true, 
            updated_at: new Date().toISOString() 
          })
          .eq('id', message.id)
          .eq('sender_id', currentUser);
          
        if(error) {
          toast('–û—à–∏–±–∫–∞: ' + error.message);
        } else {
          closeModal();
          toast('–°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
        }
      };
    }

    async function deleteMessageConfirm(messageId) {
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
      
      const { error } = await supabase
        .from('messages')
        .update({ 
          deleted: true, 
          content: null 
        })
        .eq('id', messageId)
        .eq('sender_id', currentUser);
        
      if(error) {
        toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
      } else {
        toast('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
      }
    }

    function openEmojiForMessage(messageId) {
      try {
        const emojiPicker = new EmojiButton({ position: 'top-end', zIndex: 9999 });
        emojiPicker.on('emoji', async (emoji) => {
          const existing = (reactionsCache[messageId] || []).find(r => r.user_id === currentUser && r.emoji === emoji);
          if(existing){
            await supabase
              .from('message_reactions')
              .delete()
              .eq('message_id', messageId)
              .eq('user_id', currentUser)
              .eq('emoji', emoji);
          } else {
            await supabase
              .from('message_reactions')
              .insert({ 
                message_id: messageId, 
                user_id: currentUser, 
                emoji 
              });
          }
        });
        
        emojiPicker.pickerVisible ? emojiPicker.hidePicker() : emojiPicker.showPicker($('#emojiBtn'));
      } catch (err) {
        console.warn('‚ö†Ô∏è Emoji picker –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:', err);
        toast('–†–µ–∞–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
      }
    }

    function openCreateChat() {
      openModal(`
        <h3>–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</h3>
        <div class="field" style="margin-top:8px">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ (–¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞)</label>
          <input id="cc_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
        </div>
        <div class="field" style="margin-top:8px">
          <label>–¢–∏–ø</label>
          <select id="cc_type">
            <option value="private">–õ–∏—á–Ω—ã–π (1:1)</option>
            <option value="group">–ì—Ä—É–ø–ø–∞</option>
          </select>
        </div>
        <div class="field" style="margin-top:8px">
          <label>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (@nickname, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
          <input id="cc_members" placeholder="@alice,@bob" />
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px">
          <button id="cc_create" class="btn">–°–æ–∑–¥–∞—Ç—å</button>
          <button class="btn ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `);
      
      $('#cc_create').onclick = async () => {
        const type = $('#cc_type').value;
        const isGroup = type === 'group';
        const name = $('#cc_name').value.trim();
        const raw = $('#cc_members').value.trim();
        const nicks = raw.split(',').map(s => s.trim()).filter(Boolean);
        
        let users = [];
        if(nicks.length){
          const { data: found } = await supabase
            .from('profiles')
            .select('id,nickname,avatar_url')
            .in('nickname', nicks);
            
          if(found) users.push(...found);
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞
        if(!isGroup && users.length === 1){
          const otherId = users[0].id;
          
          // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∏—á–Ω—ã–π —á–∞—Ç
          const { data: existingChats } = await supabase
            .from('chats')
            .select('id,is_group')
            .eq('is_group', false)
            .in('id', 
              (await supabase
                .from('chat_members')
                .select('chat_id')
                .eq('user_id', currentUser)
                .then(r => r.data?.map(x => x.chat_id) || [])
              )
            );
            
          if(existingChats && existingChats.length > 0){
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —á–∞—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –≤—Ç–æ—Ä–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
            for(const chat of existingChats){
              const { data: members } = await supabase
                .from('chat_members')
                .select('user_id')
                .eq('chat_id', chat.id);
                
              if(members && members.some(m => m.user_id === otherId)){
                closeModal();
                chatsCache[chat.id] = chat;
                await loadChatMeta(chat.id);
                renderChatsList();
                openChat(chat.id);
                return;
              }
            }
          }
        }

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç
        const { data: chat, error } = await supabase
          .from('chats')
          .insert({
            name: isGroup ? (name || '–ì—Ä—É–ø–ø–∞') : null,
            is_group: isGroup,
            creator: currentUser
          })
          .select()
          .single();
        
        if(error) {
          toast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ' + error.message);
          return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        const membersToInsert = [{ 
          chat_id: chat.id, 
          user_id: currentUser, 
          role: 'creator' 
        }];
        
        for(const u of users){
          membersToInsert.push({ 
            chat_id: chat.id, 
            user_id: u.id, 
            role: 'member' 
          });
        }
        
        await supabase.from('chat_members').insert(membersToInsert);
        chatsCache[chat.id] = chat;
        closeModal();
        
        await loadChatMeta(chat.id);
        renderChatsList();
        openChat(chat.id);
        toast('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω!');
      };
    }

    function openAddMemberModal() {
      if(!activeChat) {
        toast('–í—ã–±–µ—Ä–∏ —á–∞—Ç');
        return;
      }
      
      openModal(`
        <h3>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ —á–∞—Ç</h3>
        <div class="field" style="margin-top:8px">
          <label>@nickname –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
          <input id="am_nick" placeholder="@nickname" />
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px">
          <button id="am_add" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `);
      
      $('#am_add').onclick = async () => {
        let nick = $('#am_nick').value.trim();
        if(!nick) {
          toast('–í–≤–µ–¥–∏—Ç–µ @nickname');
          return;
        }
        
        if(!nick.startsWith('@')) {
          nick = '@' + nick;
        }
        
        const { data: found } = await supabase
          .from('profiles')
          .select('id,nickname')
          .eq('nickname', nick)
          .single();
          
        if(!found) {
          toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –ª–∏ —É–∂–µ –≤ —á–∞—Ç–µ
        const { data: existing } = await supabase
          .from('chat_members')
          .select('*')
          .eq('chat_id', activeChat.id)
          .eq('user_id', found.id)
          .single();
          
        if(existing) {
          toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ —á–∞—Ç–µ');
          return;
        }
        
        const { error } = await supabase
          .from('chat_members')
          .insert({ 
            chat_id: activeChat.id, 
            user_id: found.id, 
            role: 'member' 
          });
          
        if(error) {
          toast('–û—à–∏–±–∫–∞: ' + error.message);
        } else {
          toast('–£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω');
          closeModal();
        }
      };
    }

    async function leaveChatConfirm() {
      if(!activeChat) return;
      
      if(!confirm('–í—ã–π—Ç–∏ –∏–∑ —á–∞—Ç–∞?')) return;
      
      // –ï—Å–ª–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—å —á–∞—Ç–∞
      if(activeChat.creator === currentUser){
        if(!confirm('–¢—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å —á–∞—Ç–∞. –£–¥–∞–ª–∏—Ç—å —á–∞—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é?')) return;
        
        const { error } = await supabase
          .from('chats')
          .delete()
          .eq('id', activeChat.id)
          .eq('creator', currentUser);
          
        if(error) {
          toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞: ' + error.message);
        } else {
          toast('–ß–∞—Ç —É–¥–∞–ª—ë–Ω');
          delete chatsCache[activeChat.id];
          activeChat = null;
          renderChatsList();
          clearMessages();
        }
        return;
      }
      
      // –ï—Å–ª–∏ –æ–±—ã—á–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫
      const { error } = await supabase
        .from('chat_members')
        .delete()
        .eq('chat_id', activeChat.id)
        .eq('user_id', currentUser);
        
      if(error) {
        toast('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message);
      } else {
        toast('–¢—ã –≤—ã—à–µ–ª –∏–∑ —á–∞—Ç–∞');
        delete chatsCache[activeChat.id];
        activeChat = null;
        renderChatsList();
        clearMessages();
      }
    }

    function clearMessages() {
      const messagesEl = $('#messages');
      if (messagesEl) messagesEl.innerHTML = '';
      
      $('#activeChatTitle').textContent = '–í—ã–±–µ—Ä–∏ —á–∞—Ç';
      $('#activeChatSubtitle').textContent = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ';
      
      const avatarEl = $('#activeChatAvatar');
      if (avatarEl) {
        avatarEl.style.background = '';
        avatarEl.textContent = '?';
      }
    }

    function clearUI() {
      const chatsList = $('#chatsList');
      if (chatsList) chatsList.innerHTML = '';
      
      clearMessages();
    }

    async function handleSearch() {
      const q = $('#searchInput').value.trim();
      if(!q) {
        toast('–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å');
        return;
      }
      
      console.log('üîç –ü–æ–∏—Å–∫:', q);
      
      if(q.startsWith('@')){
        const nick = q;
        const { data } = await supabase
          .from('profiles')
          .select('id,nickname,avatar_url')
          .ilike('nickname', nick + '%')
          .limit(20);
          
        if(!data || data.length === 0) {
          toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
          return;
        }
        
        openModal(`<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3><div id="searchResults" style="margin-top:8px; max-height: 400px; overflow-y: auto;"></div>`);
        const container = $('#searchResults');
        
        for(const p of data){
          const item = $c('div', { class:'chat-item' });
          item.onclick = async () => {
            const otherId = p.id;
            
            // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º –ª–∏—á–Ω—ã–π —á–∞—Ç
            const { data: existingChats } = await supabase
              .from('chats')
              .select('id,is_group')
              .eq('is_group', false)
              .in('id', 
                (await supabase
                  .from('chat_members')
                  .select('chat_id')
                  .eq('user_id', currentUser)
                  .then(r => r.data?.map(x => x.chat_id) || [])
                )
              );
              
            let chatId = null;
            
            if(existingChats && existingChats.length > 0){
              for(const chat of existingChats){
                const { data: members } = await supabase
                  .from('chat_members')
                  .select('user_id')
                  .eq('chat_id', chat.id);
                  
                if(members && members.some(m => m.user_id === otherId)){
                  chatId = chat.id;
                  break;
                }
              }
            }
            
            if(!chatId){
              // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç
              const { data: newChat } = await supabase
                .from('chats')
                .insert({
                  is_group: false,
                  creator: currentUser
                })
                .select()
                .single();
                
              if(newChat){
                await supabase.from('chat_members').insert([
                  { chat_id: newChat.id, user_id: currentUser, role: 'creator' },
                  { chat_id: newChat.id, user_id: otherId, role: 'member' }
                ]);
                chatId = newChat.id;
              }
            }
            
            if(chatId){
              closeModal();
              await loadChatMeta(chatId);
              renderChatsList();
              openChat(chatId);
            } else {
              toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç');
            }
          };
          
          const av = $c('div', { class:'avatar' });
          if(p.avatar_url) {
            av.style.background = `url(${p.avatar_url}) center/cover`;
            av.textContent = '';
          } else {
            av.textContent = (p.nickname || 'U').substring(0,2).toUpperCase();
          }
          
          const meta = $c('div', { class:'meta' });
          meta.innerHTML = `<div class="title">${p.nickname}</div><div class="subtitle">${p.id.slice(0,8)}</div>`;
          
          item.appendChild(av);
          item.appendChild(meta);
          container.appendChild(item);
        }
      } else {
        // –ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        const { data } = await supabase
          .from('chats')
          .select('id,name,avatar_url,is_group')
          .ilike('name', `%${q}%`)
          .limit(30);
          
        if(!data || data.length === 0) {
          toast('–ß–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
          return;
        }
        
        openModal(`<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ —á–∞—Ç–æ–≤</h3><div id="searchChats" style="margin-top:8px; max-height: 400px; overflow-y: auto;"></div>`);
        const cont = $('#searchChats');
        
        for(const c of data){
          const it = $c('div', { class:'chat-item' });
          it.onclick = async () => { 
            closeModal(); 
            chatsCache[c.id] = c; 
            await loadChatMeta(c.id); 
            renderChatsList(); 
            openChat(c.id); 
          };
          
          const av = $c('div', { class:'avatar' });
          if(c.avatar_url) {
            av.style.background = `url(${c.avatar_url}) center/cover`;
            av.textContent = '';
          } else {
            av.textContent = (c.name || 'C').charAt(0).toUpperCase();
          }
          
          const meta = $c('div', { class:'meta' });
          meta.innerHTML = `<div class="title">${c.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div><div class="subtitle">${c.is_group ? '–ì—Ä—É–ø–ø–∞' : '–ß–∞—Ç'}</div>`;
          
          it.appendChild(av);
          it.appendChild(meta);
          cont.appendChild(it);
        }
      }
    }

    function setupRealtime() {
      console.log('üì° –ù–∞—Å—Ç—Ä–æ–π–∫–∞ realtime –ø–æ–¥–ø–∏—Å–æ–∫...');
      
      try {
        const channel = supabase.channel('public:messages')
          .on('postgres_changes', { 
            event: 'INSERT', 
            schema: 'public', 
            table: 'messages' 
          }, payload => {
            console.log('üì® –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', payload.new);
            const record = payload.new;
            
            messagesCache[record.chat_id] = messagesCache[record.chat_id] || [];
            messagesCache[record.chat_id].push(record);
            
            loadChatMeta(record.chat_id).then(() => renderChatsList());
            
            if(activeChat && activeChat.id === record.chat_id) {
              renderMessages(record.chat_id);
            } else {
              highlightChat(record.chat_id);
            }
          })
          .on('postgres_changes', { 
            event: 'UPDATE', 
            schema: 'public', 
            table: 'messages' 
          }, payload => {
            const rec = payload.new;
            const list = messagesCache[rec.chat_id] || [];
            const idx = list.findIndex(m => m.id === rec.id);
            
            if(idx >= 0) {
              list[idx] = rec;
            } else {
              list.push(rec);
            }
            
            if(activeChat && activeChat.id === rec.chat_id) {
              renderMessages(rec.chat_id);
            }
            
            loadChatMeta(rec.chat_id).then(() => renderChatsList());
          })
          .on('postgres_changes', { 
            event: 'DELETE', 
            schema: 'public', 
            table: 'messages' 
          }, payload => {
            const rec = payload.old;
            const list = messagesCache[rec.chat_id] || [];
            messagesCache[rec.chat_id] = list.filter(m => m.id !== rec.id);
            
            if(activeChat && activeChat.id === rec.chat_id) {
              renderMessages(rec.chat_id);
            }
            
            loadChatMeta(rec.chat_id).then(() => renderChatsList());
          })
          .subscribe((status) => {
            console.log('üì° Realtime —Å—Ç–∞—Ç—É—Å:', status);
          });
          
      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ realtime:', err);
      }
    }

    async function refreshReactions(messageId) {
      try {
        const { data } = await supabase
          .from('message_reactions')
          .select('*')
          .eq('message_id', messageId);
          
        reactionsCache[messageId] = data || [];
      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–π:', err);
      }
    }
    
    function highlightChat(chatId) {
      const node = document.getElementById('chat-'+chatId);
      if(node) {
        node.classList.add('active');
        
        const badge = node.querySelector('.badge');
        if(badge) {
          badge.textContent = String(Number(badge.textContent || 0) + 1);
        } else {
          const right = node.querySelector('div:last-child') || $c('div');
          const newBadge = $c('div', { class:'badge', text: '1' });
          right.appendChild(newBadge);
          node.appendChild(right);
        }
      }
    }

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ===
async function initApp() {
  console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
  
  setupUIHandlers();
  
  // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
  supabase.auth.onAuthStateChange(async (event, session) => {
    console.log('üîë –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', event);
    
    switch (event) {
      case 'SIGNED_IN':
        console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª');
        if (session?.user) {
          await ensureProfile(session.user);
          await loadInitialData();
          setupSessionRefresh();
        }
        break;
        
      case 'SIGNED_OUT':
        console.log('üö™ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª');
        handleSignOut();
        break;
        
      case 'TOKEN_REFRESHED':
        console.log('üîÑ –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω');
        break;
        
      case 'USER_UPDATED':
        console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
        break;
        
      case 'INITIAL_SESSION':
        console.log('üîê –ù–∞—á–∞–ª—å–Ω–∞—è —Å–µ—Å—Å–∏—è');
        if (session?.user) {
          await ensureProfile(session.user);
          await loadInitialData();
          setupSessionRefresh();
        }
        break;
    }
  });

  // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  try {
    const restored = await restoreSession();
    if (!restored) {
      console.log('üë§ –ê–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
      renderAuthControls();
    }
  } catch (err) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', err);
    renderAuthControls();
  }

  setupRealtime();
  
  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
  setTimeout(() => {
    if (!currentUser) {
      renderAuthControls();
    }
  }, 1000);
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
window.supabase = supabase;
window.currentUser = () => currentUser;
window.currentProfile = () => currentProfile;
window.renderAuthControls = renderAuthControls;
window.renderProfilePreview = renderProfilePreview;
window.closeModal = closeModal;
window.forceShowAuth = renderAuthControls;
window.initApp = initApp;

document.addEventListener('DOMContentLoaded', initApp);
  </script>
  
</body>
</html>
