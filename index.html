<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Messenger</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; height: 100vh; display: flex; }
    #auth, #main-view { width: 100%; display: flex; justify-content: center; align-items: center; }
    #auth > div { width: 300px; }
    input[type="text"], input[type="password"], input[type="email"] {
      width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box;
    }
    button { padding: 10px 20px; margin: 5px 0; cursor: pointer; }
    #main-view { display: none; }
    #sidebar { width: 300px; border-right: 1px solid #ddd; flex-shrink: 0; display: flex; flex-direction: column; height: 100vh; }
    #header { padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    #chat-list-view, #user-search-view { flex: 1; overflow-y: auto; padding: 10px; }
    #chat-list { list-style: none; padding: 0; margin: 0; }
    #chat-list li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    #chat-list li:hover { background: #f5f5f5; }
    #search-results { list-style: none; padding: 0; margin: 0; }
    #search-results li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    #search-results li:hover { background: #f5f5f5; }
    #chat-view { flex: 1; display: flex; flex-direction: column; }
    #chat-header { padding: 10px; border-bottom: 1px solid #ddd; display: flex; align-items: center; }
    #messages { flex: 1; padding: 10px; overflow-y: auto; }
    .message { margin: 5px 0; padding: 10px; border-radius: 8px; max-width: 60%; position: relative; display: inline-block; }
    .sent { background: #dcf8c6; align-self: flex-end; }
    .received { background: #fff; align-self: flex-start; }
    .reaction { cursor: pointer; margin-right: 5px; }
    .reactions { margin-top: 5px; display: flex; flex-wrap: wrap; }
    .reaction-count { font-size: 12px; margin-left: 4px; }
    #message-input-area { padding: 10px; border-top: 1px solid #ddd; display: flex; }
    #message-input { flex: 1; padding: 8px; }
    @media (max-width: 600px) {
      body { display: block; }
      #sidebar { width: 100%; }
      #chat-view { display: none; }
    }
  </style>
</head>
<body>
  <div id="auth">
    <div>
      <div id="login-view">
        <h2>–í—Ö–æ–¥</h2>
        <input id="login-email" type="email" placeholder="Email">
        <input id="login-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button id="login-button">–í–æ–π—Ç–∏</button>
        <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="show-signup">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
      </div>
      <div id="signup-view" style="display:none;">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <input id="signup-email" type="email" placeholder="Email">
        <input id="signup-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <input id="signup-password2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
        <button id="signup-button">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" id="show-login">–í–æ–π—Ç–∏</a></p>
      </div>
      <div id="nickname-view" style="display:none;">
        <h2>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º</h2>
        <input id="nickname-input" type="text" placeholder="@nickname">
        <button id="nickname-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="main-view">
    <div id="sidebar">
      <div id="header">
        <span id="current-user"></span>
        <button id="logout-button">–í—ã–π—Ç–∏</button>
      </div>
      <div id="chat-list-view">
        <h3>–ß–∞—Ç—ã</h3>
        <ul id="chat-list"></ul>
        <button id="new-chat-button">–ù–æ–≤—ã–π —á–∞—Ç</button>
      </div>
      <div id="user-search-view" style="display:none;">
        <button id="back-to-chats">‚Üê –ù–∞–∑–∞–¥</button>
        <h3>–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
        <input id="search-nickname" type="text" placeholder="@–Ω–∏–∫–Ω–µ–π–º">
        <ul id="search-results"></ul>
      </div>
    </div>
    <div id="chat-view">
      <div id="chat-header">
        <button id="back-to-chat-list">‚Üê –ù–∞–∑–∞–¥</button>
        <span id="chat-with"></span>
      </div>
      <div id="messages"></div>
      <div id="message-input-area">
        <input id="message-input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="send-button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://ahrfdakfvhyvphsdzwex.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_RLUW9ZE0dl6t46ZVkJXaKA_DpaGNwzv';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentChatId = null;
    let currentChatUserId = null;
    let currentChatUserNickname = '';
    let messageChannel = null;
    let reactionChannel = null;
    let currentMessages = [];

    // Emojis for reactions
    const reactionsList = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò°'];

    // Handle auth state change
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (event === 'SIGNED_IN') {
        handleLoggedIn(session.user);
      }
      if (event === 'SIGNED_OUT') {
        handleLoggedOut();
      }
    });

    // Check existing session on load
    window.addEventListener('load', async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        handleLoggedIn(session.user);
      } else {
        showAuth();
      }
    });

    // Show/hide auth/main views
    function showAuth() {
      document.getElementById('auth').style.display = 'flex';
      document.getElementById('main-view').style.display = 'none';
    }
    function showMain() {
      document.getElementById('auth').style.display = 'none';
      document.getElementById('main-view').style.display = 'flex';
    }

    // Login
    document.getElementById('login-button').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        alert(error.message);
      }
    });

    // Show signup form
    document.getElementById('show-signup').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('login-view').style.display = 'none';
      document.getElementById('signup-view').style.display = 'block';
    });
    // Show login form
    document.getElementById('show-login').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('signup-view').style.display = 'none';
      document.getElementById('login-view').style.display = 'block';
    });

    // Signup
    document.getElementById('signup-button').addEventListener('click', async () => {
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const password2 = document.getElementById('signup-password2').value;
      if (password !== password2) {
        alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
        return;
      }
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) {
        alert(error.message);
      } else {
        // Show nickname input
        document.getElementById('signup-view').style.display = 'none';
        document.getElementById('nickname-view').style.display = 'block';
      }
    });

    // Save nickname after signup
    document.getElementById('nickname-button').addEventListener('click', async () => {
      let nickname = document.getElementById('nickname-input').value.trim();
      if (!nickname.startsWith('@')) nickname = '@' + nickname;
      // Check uniqueness
      const { data: exists } = await supabase.from('profiles').select('id').eq('nickname', nickname);
      if (exists && exists.length > 0) {
        alert('–ù–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç');
        return;
      }
      const { data: { user } } = await supabase.auth.getUser();
      const { error } = await supabase.from('profiles').insert([{ id: user.id, email: user.email, nickname }]);
      if (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∏–∫–Ω–µ–π–º–∞');
      } else {
        handleLoggedIn(user);
      }
    });

    // Logout
    document.getElementById('logout-button').addEventListener('click', async () => {
      await supabase.auth.signOut();
    });

    // Handle login successful
    async function handleLoggedIn(user) {
      currentUser = user;
      document.getElementById('current-user').textContent = user.email;
      // Fetch or create profile
      const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
      if (error || !profile) {
        showMain();
        document.getElementById('nickname-view').style.display = 'block';
        return;
      }
      currentUser.nickname = profile.nickname;
      document.getElementById('current-user').textContent = profile.nickname;
      showMain();
      loadChatList();
      requestNotificationPermission();
    }

    // Handle logout
    function handleLoggedOut() {
      currentUser = null;
      currentChatId = null;
      document.getElementById('chat-list').innerHTML = '';
      document.getElementById('messages').innerHTML = '';
      document.getElementById('auth').style.display = 'flex';
      document.getElementById('main-view').style.display = 'none';
    }

    // Request browser notification permission
    function requestNotificationPermission() {
      if ("Notification" in window && Notification.permission !== 'granted') {
        Notification.requestPermission();
      }
    }

    // Load list of chats
    async function loadChatList() {
      const { data: chatMembers } = await supabase.from('chat_members').select('chat_id').eq('member_id', currentUser.id);
      document.getElementById('chat-list').innerHTML = '';
      for (let cm of chatMembers) {
        const chatId = cm.chat_id;
        const { data: others } = await supabase.from('chat_members').select('member_id').eq('chat_id', chatId).neq('member_id', currentUser.id);
        const otherId = (others && others[0]) ? others[0].member_id : null;
        if (!otherId) continue;
        const { data: prof } = await supabase.from('profiles').select('nickname').eq('id', otherId).single();
        const nickname = prof.nickname;
        const li = document.createElement('li');
        li.textContent = nickname;
        li.dataset.chatId = chatId;
        li.dataset.chatUserId = otherId;
        li.addEventListener('click', () => openChat(chatId, otherId, nickname));
        document.getElementById('chat-list').appendChild(li);
      }
    }

    // Open or create chat with user
    async function openChat(chatId, userId, nickname) {
      currentChatId = chatId;
      currentChatUserId = userId;
      currentChatUserNickname = nickname;
      document.getElementById('chat-with').textContent = nickname;
      if (window.innerWidth <= 600) {
        document.getElementById('sidebar').style.display = 'none';
        document.getElementById('chat-view').style.display = 'flex';
      }
      document.getElementById('chat-list-view').style.display = 'none';
      document.getElementById('user-search-view').style.display = 'none';
      document.getElementById('chat-view').style.display = 'flex';
      if (messageChannel) supabase.removeChannel(messageChannel);
      if (reactionChannel) supabase.removeChannel(reactionChannel);
      loadMessages();
    }

    // Load or create chat by userId
    async function getOrCreateChat(otherId) {
      const { data: chats1 } = await supabase.from('chat_members').select('chat_id').eq('member_id', currentUser.id);
      const { data: chats2 } = await supabase.from('chat_members').select('chat_id').eq('member_id', otherId);
      const ids1 = chats1.map(c => c.chat_id);
      const ids2 = chats2.map(c => c.chat_id);
      const common = ids1.filter(id => ids2.includes(id));
      if (common.length > 0) {
        return common[0];
      } else {
        const { data: newChat } = await supabase.from('chats').insert([{}]).select('id').single();
        const newChatId = newChat.id;
        await supabase.from('chat_members').insert([
          { chat_id: newChatId, member_id: currentUser.id },
          { chat_id: newChatId, member_id: otherId }
        ]);
        loadChatList();
        return newChatId;
      }
    }

    // Search users
    document.getElementById('new-chat-button').addEventListener('click', () => {
      document.getElementById('chat-list-view').style.display = 'none';
      document.getElementById('user-search-view').style.display = 'block';
    });
    document.getElementById('back-to-chats').addEventListener('click', () => {
      document.getElementById('user-search-view').style.display = 'none';
      document.getElementById('chat-list-view').style.display = 'block';
    });

    // Perform search on enter
    document.getElementById('search-nickname').addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const term = document.getElementById('search-nickname').value.trim();
        if (!term) return;
        let query = term;
        if (!query.startsWith('@')) query = '@' + query;
        const { data: users } = await supabase.from('profiles').select('id,nickname').ilike('nickname', '%' + query + '%');
        const ul = document.getElementById('search-results');
        ul.innerHTML = '';
        users.forEach(user => {
          if (user.id === currentUser.id) return;
          const li = document.createElement('li');
          li.textContent = user.nickname;
          li.addEventListener('click', async () => {
            const chatId = await getOrCreateChat(user.id);
            openChat(chatId, user.id, user.nickname);
            ul.innerHTML = '';
            document.getElementById('search-nickname').value = '';
          });
          ul.appendChild(li);
        });
      }
    });

    // Go back to chat list on mobile
    document.getElementById('back-to-chat-list').addEventListener('click', () => {
      document.getElementById('chat-view').style.display = 'none';
      document.getElementById('sidebar').style.display = 'flex';
      document.getElementById('chat-list-view').style.display = 'block';
    });

    // Load messages for current chat
    async function loadMessages() {
      if (!currentChatId) return;
      const { data: messages } = await supabase.from('messages').select('*').eq('chat_id', currentChatId).order('created_at', { ascending: true });
      currentMessages = messages;
      document.getElementById('messages').innerHTML = '';
      if (messages) {
        for (let msg of messages) {
          addMessageToUI(msg);
        }
        scrollMessagesToBottom();
      }
      const messageIds = messages.map(m => m.id);
      if (messageIds.length > 0) {
        const { data: reactions } = await supabase.from('message_reactions').select('*').in('message_id', messageIds);
        reactions.forEach(r => {
          updateReactionUI(r);
        });
      }
      // Subscribe to new messages
      messageChannel = supabase.channel(`messages:${currentChatId}`)
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${currentChatId}` }, (payload) => {
          const newMsg = payload.new;
          addMessageToUI(newMsg);
          scrollMessagesToBottom();
          if (document.hidden && newMsg.sender_id === currentChatUserId) {
            new Notification(currentChatUserNickname, { body: newMsg.text });
          }
        })
        .subscribe();
      // Subscribe to reactions
      reactionChannel = supabase.channel(`reactions:${currentChatId}`)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'message_reactions' }, (payload) => {
          if (payload.new && !payload.old) {
            updateReactionUI(payload.new);
          } else if (payload.old) {
            loadMessages();
          }
        })
        .subscribe();
    }

    // Add a message element to UI
    function addMessageToUI(msg) {
      const messagesDiv = document.getElementById('messages');
      const div = document.createElement('div');
      div.classList.add('message');
      div.classList.add(msg.sender_id === currentUser.id ? 'sent' : 'received');
      div.dataset.messageId = msg.id;
      const textDiv = document.createElement('div');
      textDiv.textContent = msg.text;
      div.appendChild(textDiv);
      const reactionsDiv = document.createElement('div');
      reactionsDiv.classList.add('reactions');
      reactionsList.forEach(emoji => {
        const span = document.createElement('span');
        span.classList.add('reaction');
        span.dataset.reaction = emoji;
        span.textContent = emoji;
        span.addEventListener('click', () => reactToMessage(msg.id, emoji));
        const countSpan = document.createElement('span');
        countSpan.textContent = '0';
        countSpan.classList.add('reaction-count');
        span.appendChild(countSpan);
        reactionsDiv.appendChild(span);
      });
      div.appendChild(reactionsDiv);
      messagesDiv.appendChild(div);
    }

    // Scroll messages to bottom
    function scrollMessagesToBottom() {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Handle reaction click
    async function reactToMessage(messageId, emoji) {
      const existing = await supabase.from('message_reactions').select('*').eq('message_id', messageId).eq('user_id', currentUser.id).single();
      if (existing.data) {
        if (existing.data.reaction === emoji) {
          await supabase.from('message_reactions').delete().eq('message_id', messageId).eq('user_id', currentUser.id);
        } else {
          await supabase.from('message_reactions').upsert({ message_id: messageId, user_id: currentUser.id, reaction: emoji });
        }
      } else {
        await supabase.from('message_reactions').insert({ message_id: messageId, user_id: currentUser.id, reaction: emoji });
      }
    }

    // Update reaction UI for a message
    function updateReactionUI(r) {
      const msgId = r.message_id;
      const emoji = r.reaction;
      const span = document.querySelector(`.message[data-message-id="${msgId}"] .reaction[data-reaction="${emoji}"]`);
      const countSpan = span ? span.querySelector('.reaction-count') : null;
      if (countSpan) {
        let count = parseInt(countSpan.textContent);
        if (isNaN(count)) count = 0;
        count++;
        countSpan.textContent = count;
      }
    }

    // Send message
    document.getElementById('send-button').addEventListener('click', async () => {
      const text = document.getElementById('message-input').value;
      if (text && currentChatId) {
        await supabase.from('messages').insert([{ chat_id: currentChatId, sender_id: currentUser.id, text }]);
        document.getElementById('message-input').value = '';
      }
    });

    // Send message on Enter key
    document.getElementById('message-input').addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const text = document.getElementById('message-input').value;
        if (text && currentChatId) {
          await supabase.from('messages').insert([{ chat_id: currentChatId, sender_id: currentUser.id, text }]);
          document.getElementById('message-input').value = '';
        }
      }
    });
  </script>
</body>
</html>
